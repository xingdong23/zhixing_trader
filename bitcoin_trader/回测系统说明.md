# 回测系统使用说明

## 系统架构

回测系统采用优雅的模块化设计：

```
backtest/
├── __init__.py              # 模块导出
├── data_loader.py           # 数据加载器
├── backtest_engine.py       # 回测引擎
└── performance_analyzer.py  # 性能分析器

run_backtest.py              # 回测主程序
```

---

## 快速开始

### 基础用法

```bash
# 使用默认配置运行回测
python run_backtest.py

# 指定数据文件
python run_backtest.py --data backtest/ETH-USDT-1m-2025.10.23.csv

# 指定配置文件
python run_backtest.py --config config/high_frequency.json

# 指定输出文件
python run_backtest.py --output backtest/my_result.json
```

---

## 数据格式

### 输入数据格式（CSV）

```csv
instrument_name,open,high,low,close,vol,vol_ccy,vol_quote,open_time,confirm
ETH-USDT-SWAP,3839.44,3843.58,3836.71,3838.16,23503.2,2350.32,9024127.30277,1761148800000,1
```

**字段说明：**
- `open_time`: 时间戳（毫秒）
- `open/high/low/close`: OHLC价格
- `vol`: 成交量

### 数据自动处理

- ✅ 自动将1分钟数据重采样为5分钟
- ✅ 自动转换时间戳格式
- ✅ 自动处理缺失值

---

## 回测流程

### 1. 数据加载

```python
from backtest import DataLoader

loader = DataLoader('backtest/ETH-USDT-1m-2025.10.23.csv')
df_1m = loader.load()                    # 加载1分钟数据
df_5m = loader.resample_to_5m()          # 重采样为5分钟
klines = loader.to_klines(df_5m)         # 转换为策略格式
```

### 2. 策略初始化

```python
from strategies.high_frequency import HighFrequencyScalpingStrategy

strategy = HighFrequencyScalpingStrategy(parameters)
```

### 3. 运行回测

```python
from backtest import BacktestEngine

engine = BacktestEngine(strategy, initial_capital=300.0)
result = engine.run(klines, window_size=200)
```

### 4. 分析结果

```python
from backtest import PerformanceAnalyzer

PerformanceAnalyzer.print_report(result)
PerformanceAnalyzer.save_to_file(result, 'result.json')
```

---

## 回测报告解读

### 资金概况

- **初始资金**: 回测开始时的资金
- **最终资金**: 回测结束时的资金
- **总盈亏**: 最终资金 - 初始资金
- **总收益率**: (总盈亏 / 初始资金) × 100%
- **最大回撤**: 从峰值到谷底的最大跌幅

### 交易统计

- **总交易次数**: 完成的交易笔数
- **盈利次数**: 盈利的交易笔数
- **亏损次数**: 亏损的交易笔数
- **胜率**: (盈利次数 / 总交易次数) × 100%

### 盈亏分析

- **平均盈利**: 所有盈利交易的平均盈利额
- **平均亏损**: 所有亏损交易的平均亏损额
- **盈亏比**: |平均盈利 / 平均亏损|
- **平均持仓**: 平均持仓时间（分钟）

### 策略评级

系统会根据以下维度自动评分（满分100分）：

- **收益率** (30分)
  - >10%: 30分 ✓ 优秀
  - 5-10%: 20分 ○ 良好
  - 0-5%: 10分 △ 一般
  - <0%: 0分 ✗ 为负

- **胜率** (25分)
  - >60%: 25分 ✓ 优秀
  - 50-60%: 15分 ○ 良好
  - 40-50%: 5分 △ 一般
  - <40%: 0分 ✗ 偏低

- **盈亏比** (25分)
  - >2.0: 25分 ✓ 优秀
  - 1.5-2.0: 15分 ○ 良好
  - 1.0-1.5: 5分 △ 一般
  - <1.0: 0分 ✗ 偏低

- **回撤控制** (20分)
  - <10%: 20分 ✓ 优秀
  - 10-20%: 10分 ○ 良好
  - 20-30%: 5分 △ 一般
  - >30%: 0分 ✗ 过大

**评级标准：**
- A+ (80-100分): 优秀
- A (70-79分): 良好
- B+ (60-69分): 中等偏上
- B (50-59分): 中等
- C (40-49分): 及格
- D (<40分): 需要优化

---

## 常见问题

### Q1: 为什么没有产生任何交易？

**可能原因：**

1. **时段过滤开启**
   - 检查配置：`session_filter.enabled = true`
   - 数据时间不在允许的交易时段内
   - **解决方案**：关闭时段过滤或调整允许时段

2. **信号条件过于严格**
   - `volume_multiplier` 过高（如 2.0）
   - `breakout_confirmation` 过大（如 0.002）
   - **解决方案**：放宽入场条件

3. **保守模式过于严格**
   - `conservative_mode.enabled = true`
   - **解决方案**：关闭保守模式

4. **数据量不足**
   - 需要至少 200 根5分钟K线
   - **解决方案**：使用更长时间的数据

### Q2: 如何提高信号频率？

```json
{
  "session_filter": {
    "enabled": false  // 关闭时段过滤
  },
  "entry_conditions": {
    "volume_multiplier": 1.5,        // 降低成交量要求
    "breakout_confirmation": 0.001   // 降低突破确认
  },
  "conservative_mode": {
    "enabled": false  // 关闭保守模式
  }
}
```

### Q3: 如何测试不同参数组合？

创建多个配置文件：

```bash
# 保守配置
python run_backtest.py --config config/conservative.json --output backtest/result_conservative.json

# 平衡配置
python run_backtest.py --config config/balanced.json --output backtest/result_balanced.json

# 激进配置
python run_backtest.py --config config/aggressive.json --output backtest/result_aggressive.json
```

### Q4: 如何使用更多历史数据？

```bash
# 准备多天数据
python run_backtest.py --data backtest/ETH-USDT-1m-2025.10.01-31.csv
```

---

## 优化建议

### 1. 参数优化流程

```
1. 基准测试
   ├─ 使用默认参数运行回测
   └─ 记录基准指标

2. 单参数调优
   ├─ 每次只调整一个参数
   ├─ 观察对结果的影响
   └─ 记录最优值

3. 组合优化
   ├─ 组合表现最好的参数
   └─ 进行最终验证

4. 样本外测试
   ├─ 使用不同时间段数据
   └─ 验证策略稳定性
```

### 2. 关键参数调优顺序

**第一阶段：入场条件**
1. `volume_multiplier` (1.5 - 2.0)
2. `breakout_confirmation` (0.001 - 0.002)
3. `rsi_long_threshold_low` (40 - 50)
4. `rsi_short_threshold_high` (50 - 60)

**第二阶段：出场条件**
1. `stop_loss_max` (0.008 - 0.012)
2. `take_profit_max` (0.020 - 0.030)
3. `profit_risk_ratio_max` (1.5 - 2.5)

**第三阶段：风险控制**
1. `max_daily_loss` (0.03 - 0.08)
2. `max_trades_per_day` (3 - 10)
3. `max_consecutive_losses` (2 - 3)

### 3. 评估指标优先级

1. **最大回撤** < 20% （必须满足）
2. **盈亏比** > 1.5 （重要）
3. **胜率** > 45% （重要）
4. **总收益率** > 5% （期望）

---

## 高级用法

### 批量回测

创建批量回测脚本：

```python
import subprocess
import json

configs = [
    'config/conservative.json',
    'config/balanced.json',
    'config/aggressive.json'
]

results = []
for config in configs:
    output = f"backtest/result_{config.split('/')[-1]}"
    subprocess.run([
        'python', 'run_backtest.py',
        '--config', config,
        '--output', output
    ])
    
    with open(output) as f:
        results.append(json.load(f))

# 比较结果
for i, result in enumerate(results):
    print(f"\n配置 {configs[i]}:")
    print(f"  收益率: {result['summary']['total_return']:.2f}%")
    print(f"  胜率: {result['summary']['win_rate']:.2f}%")
    print(f"  最大回撤: {result['summary']['max_drawdown']:.2f}%")
```

### 自定义分析

```python
from backtest import DataLoader, BacktestEngine
from strategies.high_frequency import HighFrequencyScalpingStrategy
import json

# 加载配置和数据
with open('config/high_frequency.json') as f:
    config = json.load(f)

loader = DataLoader('backtest/ETH-USDT-1m-2025.10.23.csv')
klines = loader.to_klines(loader.resample_to_5m())

# 运行回测
strategy = HighFrequencyScalpingStrategy(prepare_params(config))
engine = BacktestEngine(strategy, config['trading']['capital'])
result = engine.run(klines)

# 自定义分析
trades = result['trades']
print(f"最大单笔盈利: {max(t['pnl_amount'] for t in trades):.2f}")
print(f"最大单笔亏损: {min(t['pnl_amount'] for t in trades):.2f}")
print(f"最长持仓: {max(t['holding_time'] for t in trades):.1f} 分钟")
```

---

## 注意事项

⚠️ **回测局限性**

1. **滑点未考虑**: 实盘会有滑点成本
2. **手续费简化**: 未包含详细手续费计算
3. **流动性假设**: 假设所有订单都能成交
4. **数据质量**: 依赖历史数据的准确性

⚠️ **过度拟合风险**

- 不要在同一数据集上反复优化
- 使用样本外数据验证
- 保持参数的合理性和可解释性

⚠️ **实盘差异**

- 回测表现 ≠ 实盘表现
- 建议先用模拟盘验证
- 小资金实盘测试后再放大

---

## 总结

✅ **优雅的回测系统**
- 模块化设计，易于扩展
- 完整的性能分析
- 自动化的评级系统

✅ **使用建议**
- 从保守参数开始
- 逐步优化调整
- 样本外验证
- 模拟盘测试
- 小资金实盘

✅ **持续改进**
- 记录每次回测结果
- 分析失败交易
- 优化策略逻辑
- 完善风控机制
