# 生产环境部署指南 🚀

## ⚠️ 极其重要！涉及真金白银！

本指南提供完整的生产环境部署方案，确保程序在阿里云上稳定运行，具备自动恢复能力。

## 核心安全机制

### 1. 持仓持久化 ✅
- 每次开仓立即保存到文件
- 程序重启自动恢复持仓
- 止损止盈不会失效

### 2. 自动重启 ✅
- systemd守护进程
- 程序崩溃自动重启
- 10秒后重新启动

### 3. 健康检查 ✅
- 每分钟自动检查
- 异常自动告警
- 多维度监控

### 4. 异常告警 ✅
- 钉钉/企业微信通知
- 实时告警推送
- 关键事件通知

## 部署架构

```
阿里云ECS
├── systemd服务（自动重启）
├── 持仓文件（持久化）
├── 健康检查（定时任务）
├── 日志轮转（自动清理）
└── 告警通知（钉钉/企业微信）
```

## 快速部署

### 步骤1：上传代码到服务器

```bash
# 在本地打包
tar -czf bitcoin_trader.tar.gz bitcoin_trader/

# 上传到服务器
scp bitcoin_trader.tar.gz root@your-server:/tmp/

# 在服务器上解压
ssh root@your-server
cd /tmp
tar -xzf bitcoin_trader.tar.gz
cd bitcoin_trader
```

### 步骤2：运行部署脚本

```bash
# 赋予执行权限
chmod +x deployment/deploy.sh

# 运行部署（需要root权限）
sudo bash deployment/deploy.sh
```

部署脚本会自动：
- ✅ 创建部署用户
- ✅ 安装系统依赖
- ✅ 配置Python环境
- ✅ 设置systemd服务
- ✅ 配置健康检查
- ✅ 设置日志轮转

### 步骤3：配置API密钥

```bash
# 切换到部署用户
su - trader

# 配置.env文件
cd /home/trader/bitcoin_trader
cp .env.example .env
nano .env

# 填入你的OKX实盘API密钥
OKX_API_KEY=your_live_api_key
OKX_API_SECRET=your_live_api_secret
OKX_PASSPHRASE=your_live_passphrase
```

### 步骤4：配置告警webhook

```bash
# 编辑健康检查脚本
nano deployment/health_check.sh

# 修改webhook地址
ALERT_WEBHOOK="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
```

### 步骤5：启动服务

```bash
# 启动服务
sudo systemctl start bitcoin_trader

# 查看状态
sudo systemctl status bitcoin_trader

# 查看日志
tail -f /home/trader/bitcoin_trader/logs/high_frequency_*.log
```

## 自动恢复机制详解

### 场景1：程序崩溃

```
1. 程序因异常崩溃
   ↓
2. systemd检测到进程退出
   ↓
3. 等待10秒
   ↓
4. 自动重启程序
   ↓
5. 程序启动，从position_state.json恢复持仓
   ↓
6. 继续监控，正常止损止盈
```

**配置：**
```ini
[Service]
Restart=always
RestartSec=10
```

### 场景2：服务器重启

```
1. 服务器重启（断电/维护）
   ↓
2. 系统启动
   ↓
3. systemd自动启动bitcoin_trader服务
   ↓
4. 程序启动，从position_state.json恢复持仓
   ↓
5. 继续监控，正常止损止盈
```

**配置：**
```ini
[Install]
WantedBy=multi-user.target
```

### 场景3：程序卡死

```
1. 程序运行但不响应
   ↓
2. 健康检查发现日志超过5分钟未更新
   ↓
3. 发送告警到钉钉/企业微信
   ↓
4. 运维人员收到通知
   ↓
5. 手动重启：sudo systemctl restart bitcoin_trader
```

**配置：**
```bash
# crontab每分钟执行
* * * * * /home/trader/bitcoin_trader/deployment/health_check.sh
```

### 场景4：网络中断

```
1. 网络临时中断
   ↓
2. 程序内部会重试API调用
   ↓
3. 网络恢复后继续运行
   ↓
4. 如果长时间中断导致程序崩溃
   ↓
5. systemd自动重启
```

## 监控和告警

### 健康检查项目

1. **进程检查**
   - 检查服务是否运行
   - 异常：发送告警

2. **日志检查**
   - 检查日志是否更新
   - 超过5分钟未更新：发送告警

3. **持仓检查**
   - 检查是否有持仓
   - 有持仓时更频繁检查

4. **磁盘检查**
   - 检查磁盘空间
   - 超过90%：发送告警

5. **内存检查**
   - 检查内存使用
   - 超过90%：记录日志

### 告警示例

**钉钉告警：**
```
交易程序告警: 交易程序进程已停止
时间: 2025-10-25 19:30:00
服务器: aliyun-trader-01
```

**企业微信告警：**
```
🚨 交易程序异常
- 类型: 日志未更新
- 时间: 2025-10-25 19:30:00
- 详情: 日志超过5分钟未更新，程序可能卡死
```

## 日常运维命令

### 查看服务状态
```bash
sudo systemctl status bitcoin_trader
```

### 启动服务
```bash
sudo systemctl start bitcoin_trader
```

### 停止服务
```bash
sudo systemctl stop bitcoin_trader
```

### 重启服务
```bash
sudo systemctl restart bitcoin_trader
```

### 查看实时日志
```bash
tail -f /home/trader/bitcoin_trader/logs/high_frequency_*.log
```

### 查看持仓状态
```bash
cat /home/trader/bitcoin_trader/position_state.json | jq
```

### 手动运行健康检查
```bash
bash /home/trader/bitcoin_trader/deployment/health_check.sh
```

### 查看健康检查日志
```bash
tail -f /home/trader/bitcoin_trader/logs/health_check.log
```

## 紧急处理流程

### 情况1：收到告警但程序正常

```bash
# 1. 查看服务状态
sudo systemctl status bitcoin_trader

# 2. 查看最新日志
tail -100 /home/trader/bitcoin_trader/logs/high_frequency_*.log

# 3. 检查持仓
cat /home/trader/bitcoin_trader/position_state.json

# 4. 如果一切正常，可能是误报
```

### 情况2：程序已停止

```bash
# 1. 检查持仓（重要！）
cat /home/trader/bitcoin_trader/position_state.json

# 2. 如果有持仓，立即重启
sudo systemctl start bitcoin_trader

# 3. 确认持仓已恢复
tail -f /home/trader/bitcoin_trader/logs/high_frequency_*.log
# 应该看到：⚠️  检测到未平仓持仓，已恢复
```

### 情况3：需要紧急平仓

```bash
# 如果需要手动平仓（极端情况）
# 1. 登录OKX网页版
# 2. 手动平仓
# 3. 停止程序
sudo systemctl stop bitcoin_trader
# 4. 清空持仓文件
echo '{"position": null}' > /home/trader/bitcoin_trader/position_state.json
```

## 安全检查清单

### 部署前检查

- [ ] API密钥已配置（实盘Key）
- [ ] 告警webhook已配置
- [ ] 策略参数已确认
- [ ] 风险控制参数已设置
- [ ] 在模拟盘充分测试

### 部署后检查

- [ ] 服务正常启动
- [ ] 日志正常输出
- [ ] 健康检查正常运行
- [ ] 告警通知正常接收
- [ ] 持仓文件正常创建

### 每日检查

- [ ] 查看交易日志
- [ ] 检查盈亏情况
- [ ] 确认无异常告警
- [ ] 检查磁盘空间
- [ ] 查看健康检查日志

## 重要注意事项

### ⚠️ 1. API密钥安全
- 使用实盘API Key
- 设置IP白名单
- 限制API权限（只需要交易权限）
- 定期更换密钥

### ⚠️ 2. 资金管理
- 初始资金不要太大
- 严格遵守风险控制
- 定期提取盈利
- 监控账户余额

### ⚠️ 3. 监控告警
- 必须配置告警webhook
- 确保能收到通知
- 及时处理告警
- 定期测试告警

### ⚠️ 4. 备份恢复
- 定期备份配置文件
- 保存持仓文件
- 记录交易日志
- 准备应急预案

### ⚠️ 5. 服务器安全
- 使用防火墙
- 禁用root登录
- 使用SSH密钥
- 定期更新系统

## 故障排查

### 问题1：服务无法启动

```bash
# 查看详细错误
sudo journalctl -u bitcoin_trader -n 50

# 检查配置文件
cat /etc/systemd/system/bitcoin_trader.service

# 检查Python环境
su - trader -c "cd /home/trader/bitcoin_trader && .venv/bin/python --version"
```

### 问题2：持仓未恢复

```bash
# 检查持仓文件
cat /home/trader/bitcoin_trader/position_state.json

# 检查文件权限
ls -l /home/trader/bitcoin_trader/position_state.json

# 查看启动日志
grep "持仓" /home/trader/bitcoin_trader/logs/high_frequency_*.log
```

### 问题3：告警未收到

```bash
# 测试webhook
curl -X POST "YOUR_WEBHOOK_URL" \
  -H 'Content-Type: application/json' \
  -d '{"msgtype":"text","text":{"content":"测试告警"}}'

# 检查健康检查日志
tail -f /home/trader/bitcoin_trader/logs/health_check.log
```

## 性能优化

### 1. 日志管理
- 自动轮转（每天）
- 保留30天
- 自动压缩

### 2. 资源限制
- 内存限制：2G
- 文件描述符：65536

### 3. 重启策略
- 10秒后重启
- 10分钟内最多重启5次

## 总结

✅ **完整的自动恢复机制**
- systemd自动重启
- 持仓持久化恢复
- 健康检查监控
- 异常告警通知

✅ **生产级别的可靠性**
- 程序崩溃自动恢复
- 服务器重启自动恢复
- 持仓信息不会丢失
- 止损止盈正常执行

✅ **完善的监控体系**
- 进程监控
- 日志监控
- 资源监控
- 实时告警

现在可以放心部署到生产环境了！🎉
