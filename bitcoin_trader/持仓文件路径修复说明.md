# 持仓文件路径修复说明

## 问题描述

之前 `position_state.json` 使用相对路径，导致：
- 根目录有一个: `./position_state.json`
- app目录有一个: `./app/position_state.json`

**问题**: 根据运行目录不同，会使用不同的文件，造成混乱。

---

## 修复方案

### 1. 统一路径

现在**强制使用** `app/position_state.json`，无论从哪里运行都使用同一个文件。

### 2. 代码修改

```python
# 修改前
def __init__(self, storage_file: str = "position_state.json"):
    self.storage_file = storage_file

# 修改后
def __init__(self, storage_file: str = None):
    if storage_file is None:
        # 自动定位到 app/position_state.json
        current_dir = os.path.dirname(os.path.abspath(__file__))
        app_dir = os.path.dirname(os.path.dirname(current_dir))
        storage_file = os.path.join(app_dir, "position_state.json")
    
    self.storage_file = storage_file
    logger.info(f"持仓存储文件: {self.storage_file}")
```

### 3. 文件清理

- ❌ 删除: `./position_state.json` (根目录)
- ✅ 保留: `./app/position_state.json`

---

## 验证

### 运行日志

现在启动策略时会看到：

```
INFO - 持仓存储文件: /path/to/bitcoin_trader/app/position_state.json
INFO - 当前无持仓
```

### 文件位置

```bash
$ find . -name "position_state.json"
./app/position_state.json
```

只有一个文件！✅

---

## 使用说明

### 1. 正常使用

不需要任何改动，系统会自动使用正确的路径：

```python
from app.strategies.high_frequency import HighFrequencyScalpingStrategy

# 自动使用 app/position_state.json
strategy = HighFrequencyScalpingStrategy(parameters)
```

### 2. 自定义路径（可选）

如果需要指定其他路径：

```python
# 在策略配置中指定
storage = PositionStorage(storage_file="/custom/path/position.json")
```

---

## 注意事项

### ⚠️ 旧数据迁移

如果根目录的 `position_state.json` 有重要持仓数据：

```bash
# 备份旧文件
cp position_state.json position_state_backup.json

# 如果需要，手动合并到 app/position_state.json
# 或者在下次开仓时会自动创建新的
```

### ✅ 新部署

新部署不需要任何操作，系统会自动创建 `app/position_state.json`。

---

## 文件结构

```
bitcoin_trader/
├── app/
│   ├── position_state.json      # ✅ 持仓文件（唯一）
│   ├── strategies/
│   │   └── high_frequency/
│   │       └── position_storage.py  # 持仓存储模块
│   └── ...
└── ...
```

---

## 总结

✅ **问题已修复**
- 统一使用 `app/position_state.json`
- 无论从哪里运行都使用同一个文件
- 自动路径定位，无需手动配置

✅ **向后兼容**
- 支持自定义路径
- 不影响现有功能

✅ **清晰明确**
- 只有一个持仓文件
- 日志明确显示文件路径

---

修复时间: 2025-10-25 20:59
