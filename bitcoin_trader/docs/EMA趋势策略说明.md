# EMA趋势跟随短线策略说明

## 策略概述

这是一个基于多条EMA均线的趋势跟随短线交易策略，专注于顺势交易，在趋势明确时寻找回调/反弹机会入场。

## 核心理念

### 1. 趋势判断
使用三条EMA均线判断市场趋势：
- **EMA8**（快速线）
- **EMA21**（中速线）
- **EMA55**（慢速线）

**趋势定义：**
- **上升趋势**：EMA8 > EMA21 > EMA55（连续3根K线确认）
- **下降趋势**：EMA8 < EMA21 < EMA55（连续3根K线确认）
- **震荡趋势**：其他情况（不交易）

### 2. 入场信号

#### 做多条件（上升趋势）
1. 市场处于上升趋势
2. 价格回踩到EMA55附近（±1.5%以内）
3. 出现反弹迹象（K线收盘价高于前一根）

#### 做空条件（下降趋势）
1. 市场处于下降趋势
2. 价格反弹到EMA55附近（±1.5%以内）
3. 出现回落迹象（K线收盘价低于前一根）

### 3. 止损策略

采用**双重止损保护**，取较小值：
- **ATR止损**：入场价 ± (ATR × 2.0)
- **固定止损**：最大亏损4%

**示例：**
- 入场价：50,000 USDT
- ATR = 400
- ATR止损 = 50,000 - (400 × 2) = 49,200
- 固定止损 = 50,000 × (1 - 0.04) = 48,000
- **实际止损**：49,200（取较小的亏损）

### 4. 止盈策略

采用**分批止盈 + 移动止损**：

| 目标 | 利润 | 平仓比例 | 操作 |
|------|------|----------|------|
| 第一目标 | 5% | 50% | 平仓一半，止损移至成本价 |
| 第二目标 | 10% | 30% | 平仓30%，继续持有 |
| 第三目标 | 15% | 20% | 平仓剩余20%，完全退出 |

**移动止损：**
- 当利润达到5%时，启动移动止损
- 止损距离：当前价格的2%
- 止损只向有利方向移动

## 策略参数

### 默认参数配置

```python
{
    # EMA参数
    "ema_fast": 8,          # 快速EMA周期
    "ema_medium": 21,       # 中速EMA周期
    "ema_slow": 55,         # 慢速EMA周期
    
    # 入场参数
    "pullback_threshold": 0.015,    # 回踩阈值1.5%
    "trend_confirm_bars": 3,        # 趋势确认K线数
    
    # 止损参数
    "atr_period": 14,               # ATR周期
    "atr_multiplier": 2.0,          # ATR倍数
    "max_loss_ratio": 0.04,         # 最大亏损4%
    
    # 止盈参数
    "first_profit_target": 0.05,    # 第一目标5%
    "first_close_ratio": 0.5,       # 平仓50%
    "second_profit_target": 0.10,   # 第二目标10%
    "second_close_ratio": 0.3,      # 平仓30%
    "third_profit_target": 0.15,    # 第三目标15%
    "third_close_ratio": 0.2,       # 平仓20%
    
    # 移动止损参数
    "trailing_stop_activation": 0.05,  # 5%利润启动
    "trailing_stop_distance": 0.02,    # 距离2%
    
    # 仓位管理
    "position_ratio": 0.3,          # 默认仓位30%
}
```

### 参数调整建议

#### 保守型（适合新手）
```python
{
    "position_ratio": 0.2,          # 仓位降至20%
    "max_loss_ratio": 0.03,         # 最大亏损3%
    "atr_multiplier": 1.5,          # ATR倍数降低
    "first_profit_target": 0.03,    # 第一目标降至3%
}
```

#### 激进型（适合经验丰富者）
```python
{
    "position_ratio": 0.5,          # 仓位提升至50%
    "max_loss_ratio": 0.05,         # 最大亏损5%
    "atr_multiplier": 2.5,          # ATR倍数提高
    "pullback_threshold": 0.02,     # 回踩阈值放宽至2%
}
```

## 使用示例

### 1. 基础使用

```python
from app.core.strategies import EMATrendStrategy

# 创建策略实例（使用默认参数）
strategy = EMATrendStrategy()

# 准备K线数据
klines = [
    {
        "open": 50000,
        "high": 50500,
        "low": 49800,
        "close": 50200,
        "volume": 1000000
    },
    # ... 更多K线数据（至少100根）
]

# 分析生成信号
signal = strategy.analyze(klines)

# 处理信号
if signal['signal'] == 'buy':
    print(f"做多信号！入场价：{signal['price']}")
    print(f"止损价：{signal['stop_loss']}")
    print(f"仓位：{signal['position_ratio']}")
    
    # 执行交易后更新持仓
    strategy.update_position(signal)
    
elif signal['signal'] == 'sell':
    print(f"做空信号！入场价：{signal['price']}")
    # ...
```

### 2. 自定义参数

```python
# 自定义参数
custom_params = {
    "ema_fast": 5,
    "ema_medium": 13,
    "ema_slow": 34,
    "max_loss_ratio": 0.03,
    "position_ratio": 0.25,
}

strategy = EMATrendStrategy(custom_params)
```

### 3. 实时监控

```python
# 在实时行情中使用
while True:
    # 获取最新K线数据
    klines = get_latest_klines()
    
    # 分析信号
    signal = strategy.analyze(klines)
    
    # 处理信号
    if signal['signal'] != 'hold':
        execute_trade(signal)
        strategy.update_position(signal)
```

## 策略优势

1. **趋势跟随**：只在趋势明确时交易，避免震荡市场
2. **顺势而为**：不逆势交易，降低风险
3. **严格止损**：双重止损保护，最大亏损可控
4. **分批止盈**：保护利润，让盈利奔跑
5. **移动止损**：锁定利润，避免回撤
6. **参数灵活**：可根据市场和个人风险偏好调整

## 策略劣势

1. **震荡市场**：在震荡市场中不产生信号，可能错过机会
2. **回踩要求**：需要等待价格回踩EMA55，可能错过强势突破
3. **趋势反转**：在趋势反转初期可能产生错误信号
4. **参数敏感**：EMA周期选择会影响信号质量

## 风险提示

⚠️ **重要提示：**

1. **历史表现不代表未来**：过去的收益不保证未来盈利
2. **严格执行止损**：永远不要移除或放宽止损
3. **控制仓位**：不要过度杠杆，建议单笔仓位不超过30%
4. **市场环境**：策略在趋势市场表现较好，震荡市场表现一般
5. **滑点和手续费**：实盘交易需考虑滑点和手续费成本
6. **情绪控制**：严格按照策略信号执行，不要情绪化交易

## 回测建议

在实盘使用前，建议进行充分的回测：

1. **数据周期**：至少使用1年以上的历史数据
2. **不同市场**：在牛市、熊市、震荡市场分别测试
3. **参数优化**：测试不同参数组合，找到最优配置
4. **风险指标**：关注最大回撤、夏普比率、胜率等指标
5. **模拟交易**：先进行模拟盘交易，验证策略有效性

## 常见问题

### Q1: 为什么选择EMA8/21/55？
A: 这是经典的斐波那契数列组合，能够较好地捕捉短期、中期、长期趋势。你也可以根据交易周期调整，如5/13/34（更短线）或13/34/89（更长线）。

### Q2: 止损被频繁触发怎么办？
A: 可能是市场波动过大或参数设置过于激进。建议：
- 增大ATR倍数（如2.5或3.0）
- 降低仓位比例
- 在波动较小的时段交易

### Q3: 如何提高胜率？
A: 
- 增加趋势确认K线数（如5根）
- 缩小回踩阈值（如1%）
- 结合其他指标（如成交量、RSI）进行二次确认

### Q4: 可以用于其他币种吗？
A: 可以，但建议：
- 针对不同币种的波动特性调整参数
- 小市值币种建议降低仓位
- 先进行充分回测

## 更新日志

### v1.0.0 (2025-10-21)
- ✅ 初始版本发布
- ✅ 实现EMA趋势判断
- ✅ 实现回踩/反弹入场逻辑
- ✅ 实现ATR动态止损
- ✅ 实现分批止盈和移动止损
- ✅ 完成单元测试

## 联系方式

如有问题或建议，欢迎反馈！
