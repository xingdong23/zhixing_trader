# 回测系统目录结构说明

## 完整目录树

```
backtest/
├── README.md                    # 回测系统使用文档
├── 目录结构说明.md              # 本文档
├── run_backtest.py              # 回测主程序入口
├── __init__.py                  # 模块初始化文件
│
├── configs/                     # 📋 配置文件目录
│   ├── backtest_config.json     # 默认回测配置
│   ├── conservative.json        # 保守配置（可选）
│   ├── balanced.json            # 平衡配置（可选）
│   └── aggressive.json          # 激进配置（可选）
│
├── data/                        # 📊 历史数据目录
│   ├── ETH-USDT-1m-2025.10.23.csv
│   ├── BTC-USDT-1m-2025.10.csv
│   └── ...                      # 其他历史数据文件
│
├── core/                        # 🔧 核心代码目录
│   ├── __init__.py              # 核心模块导出
│   ├── data_loader.py           # 数据加载器
│   ├── backtest_engine.py       # 回测引擎
│   └── performance_analyzer.py  # 性能分析器
│
└── results/                     # 📈 回测结果目录
    ├── backtest_result_20251025_204424.json
    ├── backtest_result_20251025_210000.json
    └── ...                      # 其他回测结果文件
```

---

## 目录详解

### 1. 根目录文件

#### `run_backtest.py`
- **作用**: 回测主程序入口
- **功能**: 
  - 读取配置文件
  - 加载历史数据
  - 初始化策略
  - 运行回测
  - 生成报告
- **使用**: `python backtest/run_backtest.py --config backtest/configs/backtest_config.json`

#### `README.md`
- **作用**: 完整的使用文档
- **内容**:
  - 快速开始指南
  - 配置文件说明
  - 数据格式要求
  - 使用示例
  - 常见问题

#### `__init__.py`
- **作用**: Python包初始化
- **功能**: 导出核心模块供外部使用

---

### 2. configs/ - 配置文件目录

#### 目录用途
存放所有回测相关的配置文件，支持多套配置方案。

#### 配置文件结构

**backtest_config.json** (默认配置)
```json
{
  "backtest_name": "回测名称",
  "description": "回测描述",
  
  "data": {
    "source": "data/数据文件.csv",
    "timeframe": "5m",
    "resample_from": "1m"
  },
  
  "strategy": {
    "name": "策略名称",
    "config_file": "../config/策略配置.json"
  },
  
  "backtest_settings": {
    "initial_capital": 300.0,
    "window_size": 200
  },
  
  "output": {
    "result_file": "results/backtest_result_{timestamp}.json",
    "save_trades": true
  }
}
```

#### 配置文件管理

**创建新配置**:
```bash
# 复制默认配置
cp backtest/configs/backtest_config.json backtest/configs/my_config.json

# 编辑配置
nano backtest/configs/my_config.json

# 使用新配置运行
python backtest/run_backtest.py --config backtest/configs/my_config.json
```

**推荐配置方案**:
- `backtest_config.json`: 默认配置
- `conservative.json`: 保守参数配置
- `balanced.json`: 平衡参数配置
- `aggressive.json`: 激进参数配置

---

### 3. data/ - 历史数据目录

#### 目录用途
存放所有用于回测的历史K线数据。

#### 数据命名规范
```
{交易对}-{时间框架}-{日期}.csv

示例:
ETH-USDT-1m-2025.10.23.csv       # ETH/USDT 1分钟数据 2025年10月23日
BTC-USDT-5m-2025.10.01-31.csv    # BTC/USDT 5分钟数据 2025年10月全月
SOL-USDT-1h-2025.Q3.csv          # SOL/USDT 1小时数据 2025年第3季度
```

#### 数据格式要求

**CSV格式**:
```csv
instrument_name,open,high,low,close,vol,vol_ccy,vol_quote,open_time,confirm
ETH-USDT-SWAP,3839.44,3843.58,3836.71,3838.16,23503.2,2350.32,9024127.30277,1761148800000,1
```

**必需字段**:
- `open_time`: 时间戳（毫秒）
- `open`, `high`, `low`, `close`: OHLC价格
- `vol`: 成交量

#### 数据获取方式

1. **交易所API下载**
2. **第三方数据提供商**
3. **自己采集存储**

#### 数据管理建议

```bash
# 按交易对分类
data/
├── ETH-USDT/
│   ├── 2025-10-01.csv
│   ├── 2025-10-02.csv
│   └── ...
├── BTC-USDT/
│   └── ...
└── SOL-USDT/
    └── ...

# 或按时间分类
data/
├── 2025-10/
│   ├── ETH-USDT-1m.csv
│   ├── BTC-USDT-1m.csv
│   └── ...
└── 2025-11/
    └── ...
```

---

### 4. core/ - 核心代码目录

#### 目录用途
存放回测系统的核心实现代码。

#### 模块说明

**data_loader.py** - 数据加载器
```python
class DataLoader:
    """历史数据加载器"""
    
    def load(self) -> pd.DataFrame:
        """加载CSV数据"""
        
    def resample_to_5m(self) -> pd.DataFrame:
        """重采样为5分钟"""
        
    def to_klines(self, df) -> List[Dict]:
        """转换为策略格式"""
```

**backtest_engine.py** - 回测引擎
```python
class BacktestEngine:
    """回测引擎"""
    
    def run(self, klines, window_size) -> Dict:
        """运行回测"""
        
    def _execute_signal(self, signal):
        """执行交易信号"""
        
    def _generate_report(self) -> Dict:
        """生成回测报告"""
```

**performance_analyzer.py** - 性能分析器
```python
class PerformanceAnalyzer:
    """性能分析器"""
    
    @staticmethod
    def print_report(result):
        """打印回测报告"""
        
    @staticmethod
    def save_to_file(result, filename):
        """保存结果到文件"""
```

#### 代码规范

- ✅ 类型注解完整
- ✅ 文档字符串详细
- ✅ 单一职责原则
- ✅ 易于测试和扩展

---

### 5. results/ - 回测结果目录

#### 目录用途
存放所有回测生成的结果文件。

#### 文件命名规范
```
backtest_result_{timestamp}.json

示例:
backtest_result_20251025_204424.json
backtest_result_20251025_210530.json
```

#### 结果文件内容

```json
{
  "summary": {
    "initial_capital": 300.0,
    "final_capital": 315.5,
    "total_pnl": 15.5,
    "total_return": 5.17,
    "total_trades": 10,
    "winning_trades": 6,
    "losing_trades": 4,
    "win_rate": 60.0,
    "max_drawdown": 8.5
  },
  "trades": [
    {
      "entry_time": "2025-10-23 08:15:00",
      "exit_time": "2025-10-23 08:45:00",
      "side": "long",
      "entry_price": 3850.0,
      "exit_price": 3865.0,
      "pnl_amount": 4.5,
      "pnl_ratio": 0.0039
    }
  ],
  "equity_curve": [...]
}
```

#### 结果管理

**按日期归档**:
```bash
results/
├── 2025-10/
│   ├── backtest_result_20251025_204424.json
│   └── ...
└── 2025-11/
    └── ...
```

**清理旧结果**:
```bash
# 删除30天前的结果
find backtest/results -name "*.json" -mtime +30 -delete
```

---

## 工作流程

### 标准回测流程

```
1. 准备数据
   ↓
   将CSV文件放入 data/ 目录
   
2. 配置回测
   ↓
   编辑 configs/backtest_config.json
   
3. 运行回测
   ↓
   python backtest/run_backtest.py
   
4. 查看结果
   ↓
   查看 results/ 目录中的JSON文件
   
5. 分析优化
   ↓
   根据结果调整策略参数
   
6. 重复测试
   ↓
   创建新配置，继续回测
```

### 批量回测流程

```python
# 批量测试脚本示例
configs = [
    'backtest/configs/conservative.json',
    'backtest/configs/balanced.json',
    'backtest/configs/aggressive.json'
]

for config in configs:
    subprocess.run(['python', 'backtest/run_backtest.py', '--config', config])
```

---

## 扩展指南

### 添加新的数据源

1. 在 `core/data_loader.py` 中添加新的加载方法
2. 更新配置文件支持新格式
3. 测试数据加载功能

### 添加新的性能指标

1. 在 `core/performance_analyzer.py` 中添加计算方法
2. 更新报告输出格式
3. 更新评级系统

### 添加可视化功能

1. 创建 `core/visualizer.py`
2. 实现权益曲线图表
3. 实现交易信号标注
4. 集成到回测流程

---

## 维护建议

### 定期清理

```bash
# 清理缓存文件
find backtest -name "__pycache__" -type d -exec rm -rf {} +
find backtest -name "*.pyc" -delete

# 清理旧结果（保留最近30天）
find backtest/results -name "*.json" -mtime +30 -delete
```

### 备份重要数据

```bash
# 备份配置文件
tar -czf backtest_configs_backup.tar.gz backtest/configs/

# 备份历史数据
tar -czf backtest_data_backup.tar.gz backtest/data/

# 备份重要结果
tar -czf backtest_results_backup.tar.gz backtest/results/
```

### 版本控制

**应该提交到Git**:
- ✅ `core/` 目录下的所有代码
- ✅ `configs/` 目录下的配置模板
- ✅ `README.md` 等文档

**不应该提交到Git**:
- ❌ `data/` 目录（数据文件太大）
- ❌ `results/` 目录（结果文件太多）
- ❌ `__pycache__/` 目录
- ❌ `*.pyc` 文件

**.gitignore 配置**:
```
backtest/data/*.csv
backtest/results/*.json
backtest/**/__pycache__/
backtest/**/*.pyc
```

---

## 总结

✅ **清晰的目录结构**
- configs/: 配置文件
- data/: 历史数据
- core/: 核心代码
- results/: 回测结果

✅ **专业的设计**
- 配置驱动
- 模块化代码
- 易于扩展
- 便于维护

✅ **完整的文档**
- README.md: 使用指南
- 本文档: 目录结构说明
- 代码注释: 实现细节

现在你拥有一个专业、优雅、易用的回测系统！🎉
