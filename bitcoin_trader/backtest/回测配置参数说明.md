# 回测配置参数说明

详细解释 `backtest_settings` 中每个参数的含义和作用。

---

## 配置示例

```json
{
  "backtest_settings": {
    "initial_capital": 300.0,
    "window_size": 200,
    "commission_rate": 0.0004,
    "slippage_rate": 0.0001
  }
}
```

---

## 参数详解

### 1. initial_capital (初始资金)

**类型**: `float`  
**单位**: USDT  
**默认值**: 300.0  

**说明**: 回测开始时的初始资金量。

**作用**:
- 决定每笔交易的仓位大小
- 计算最终收益率的基准
- 影响风控计算（如最大回撤）

**示例**:
```json
{
  "initial_capital": 300.0    // 从300 USDT开始回测
}
```

**建议值**:
- 小资金测试: 100 - 500 USDT
- 中等资金: 1000 - 5000 USDT
- 大资金: 10000+ USDT

**计算示例**:
```
初始资金: 300 USDT
杠杆: 3x
单笔仓位: 300 * 3 = 900 USDT 名义价值
```

---

### 2. window_size (滑动窗口大小)

**类型**: `int`  
**单位**: K线数量  
**默认值**: 200  

**说明**: 策略分析所需的最小历史K线数量。

**作用**:
- 计算技术指标（如EMA、ATR）需要足够的历史数据
- 回测从第 `window_size` 根K线开始
- 前 `window_size` 根K线用于指标预热

**示例**:
```json
{
  "window_size": 200    // 需要200根K线预热
}
```

**为什么需要200根？**

策略使用的指标需要历史数据：
- EMA(200): 需要200根K线
- ATR(14): 需要14根K线
- RSI(14): 需要14根K线

取最大值 = 200

**计算示例**:
```
总K线: 288根 (24小时 * 12个5分钟)
窗口大小: 200根
实际回测: 288 - 200 = 88根K线
```

**建议值**:
- 快速指标: 50 - 100
- 中期指标: 100 - 200
- 长期指标: 200 - 500

---

### 3. commission_rate (手续费率)

**类型**: `float`  
**单位**: 比率 (0.0004 = 0.04%)  
**默认值**: 0.0004  
**当前状态**: ⚠️ 已定义但未实现

**说明**: 每笔交易的手续费率。

**作用**:
- 模拟真实交易成本
- 影响最终盈亏
- 更真实的回测结果

**示例**:
```json
{
  "commission_rate": 0.0004    // 0.04% 手续费
}
```

**常见交易所费率**:

| 交易所 | Maker | Taker | 说明 |
|--------|-------|-------|------|
| Binance | 0.02% | 0.04% | 现货 |
| Binance | 0.02% | 0.05% | 合约 |
| OKX | 0.02% | 0.05% | 合约 |
| Bybit | 0.01% | 0.06% | 合约 |

**计算示例**:
```
交易金额: 1000 USDT
手续费率: 0.0004 (0.04%)
手续费: 1000 * 0.0004 = 0.4 USDT

开仓手续费: 0.4 USDT
平仓手续费: 0.4 USDT
总手续费: 0.8 USDT
```

**⚠️ 注意**: 
目前回测引擎中**尚未实现**手续费扣除，这是待开发功能。

---

### 4. slippage_rate (滑点率)

**类型**: `float`  
**单位**: 比率 (0.0001 = 0.01%)  
**默认值**: 0.0001  
**当前状态**: ⚠️ 已定义但未实现

**说明**: 实际成交价格与预期价格的偏差。

**作用**:
- 模拟市场冲击成本
- 模拟订单簿深度影响
- 更真实的成交价格

**示例**:
```json
{
  "slippage_rate": 0.0001    // 0.01% 滑点
}
```

**什么是滑点？**

```
预期买入价: 3850.00 USDT
滑点率: 0.0001 (0.01%)
实际成交价: 3850.00 * (1 + 0.0001) = 3850.385 USDT

预期卖出价: 3860.00 USDT
滑点率: 0.0001 (0.01%)
实际成交价: 3860.00 * (1 - 0.0001) = 3859.614 USDT
```

**影响因素**:
- 市场流动性
- 订单大小
- 市场波动性
- 交易时段

**典型滑点**:
- 高流动性: 0.01% - 0.05%
- 中等流动性: 0.05% - 0.1%
- 低流动性: 0.1% - 0.5%

**⚠️ 注意**: 
目前回测引擎中**尚未实现**滑点模拟，这是待开发功能。

---

## 完整配置示例

### 示例1: 保守配置

```json
{
  "backtest_settings": {
    "initial_capital": 500.0,      // 较大初始资金
    "window_size": 200,            // 标准窗口
    "commission_rate": 0.0005,     // 较高手续费（保守估计）
    "slippage_rate": 0.0002        // 较高滑点（保守估计）
  }
}
```

**适用场景**: 
- 真实交易前的验证
- 考虑最坏情况
- 风险厌恶型策略

---

### 示例2: 标准配置

```json
{
  "backtest_settings": {
    "initial_capital": 300.0,      // 标准资金
    "window_size": 200,            // 标准窗口
    "commission_rate": 0.0004,     // 标准手续费
    "slippage_rate": 0.0001        // 标准滑点
  }
}
```

**适用场景**: 
- 日常回测
- 策略开发
- 参数优化

---

### 示例3: 理想配置

```json
{
  "backtest_settings": {
    "initial_capital": 1000.0,     // 大资金
    "window_size": 200,            // 标准窗口
    "commission_rate": 0.0002,     // 低手续费（VIP用户）
    "slippage_rate": 0.00005       // 低滑点（理想情况）
  }
}
```

**适用场景**: 
- 策略潜力评估
- 最优情况测试
- 理论收益计算

---

## 参数调优建议

### 1. initial_capital

**测试不同资金量**:
```bash
# 小资金
python backtest/run_backtest.py --config configs/capital_100.json

# 中等资金
python backtest/run_backtest.py --config configs/capital_500.json

# 大资金
python backtest/run_backtest.py --config configs/capital_5000.json
```

**观察指标**:
- 收益率是否稳定
- 回撤是否可控
- 交易频率是否合理

---

### 2. window_size

**根据策略调整**:

```python
# 快速策略（短期指标）
"window_size": 50

# 标准策略（中期指标）
"window_size": 200

# 长期策略（长期指标）
"window_size": 500
```

**注意**:
- 窗口越大，回测数据利用率越低
- 窗口越小，指标可能不准确

---

### 3. commission_rate & slippage_rate

**真实性测试**:

```json
// 乐观情况
{
  "commission_rate": 0.0002,
  "slippage_rate": 0.00005
}

// 标准情况
{
  "commission_rate": 0.0004,
  "slippage_rate": 0.0001
}

// 保守情况
{
  "commission_rate": 0.0006,
  "slippage_rate": 0.0002
}
```

**对比分析**:
- 策略在不同成本下的表现
- 找到盈亏平衡点
- 评估策略稳健性

---

## 常见问题

### Q1: 为什么手续费和滑点没有生效？

**A**: 这两个参数目前**尚未实现**，是预留的配置项。

**计划实现**:
```python
# 未来版本
def _calculate_trade_cost(self, amount, price):
    commission = amount * price * self.commission_rate
    slippage = amount * price * self.slippage_rate
    return commission + slippage
```

---

### Q2: window_size 设置多大合适？

**A**: 取决于策略使用的最长周期指标。

**计算方法**:
```
策略使用: EMA(200), ATR(14), RSI(14)
最长周期: 200
建议 window_size: 200
```

---

### Q3: initial_capital 影响回测结果吗？

**A**: 影响绝对收益，但不影响收益率。

**示例**:
```
资金100: 盈利10 USDT, 收益率10%
资金1000: 盈利100 USDT, 收益率10%
```

收益率相同，但绝对金额不同。

---

### Q4: 如何验证配置是否正确？

**A**: 查看回测日志：

```
INFO - 初始资金: 300.0 USDT
INFO - K线数量: 288
INFO - 时间范围: 2025-10-22 16:00:00 ~ 2025-10-23 15:55:00
INFO - 回测进度: 69.4% | 当前资金: 300.00 USDT
```

---

## 总结

### ✅ 当前可用参数

| 参数 | 状态 | 作用 |
|------|------|------|
| initial_capital | ✅ 已实现 | 设置初始资金 |
| window_size | ✅ 已实现 | 设置预热窗口 |
| commission_rate | ⚠️ 未实现 | 预留手续费配置 |
| slippage_rate | ⚠️ 未实现 | 预留滑点配置 |

### 📋 使用建议

1. **initial_capital**: 根据实际交易资金设置
2. **window_size**: 根据策略指标周期设置
3. **commission_rate**: 暂时忽略（未实现）
4. **slippage_rate**: 暂时忽略（未实现）

### 🔮 未来计划

- [ ] 实现手续费扣除
- [ ] 实现滑点模拟
- [ ] 支持不同交易所费率
- [ ] 支持动态滑点计算

---

更新时间: 2025-10-25 21:02
