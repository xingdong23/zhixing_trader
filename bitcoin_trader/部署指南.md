# Bitcoin Trader 阿里云部署指南

## 📋 服务器信息

- **服务器IP**: 101.42.14.209
- **用户**: root
- **密码**: czbcxy25809*
- **部署目录**: /opt/zhixing_trader
- **数据库**: MySQL (用户: root, 密码: shuzhongren)

---

## 🚀 快速部署（推荐）

### 方式一：使用部署脚本（自动化）

在本地执行：

```bash
cd /Users/chengzheng/workspace/chuangxin/zhixing_trader/bitcoin_trader
bash deploy_git.sh
```

输入服务器密码：`czbcxy25809*`

脚本会自动完成：
- ✅ 检查和安装依赖（Git, Python3, pip3）
- ✅ 克隆/拉取代码
- ✅ 安装Python依赖
- ✅ 创建配置文件
- ✅ 配置systemd服务

---

### 方式二：手动部署（逐步操作）

#### 1. 连接到服务器

```bash
ssh root@101.42.14.209
# 密码: czbcxy25809*
```

#### 2. 安装依赖

```bash
# 安装 Git
yum install -y git

# 安装 Python3 和 pip
yum install -y python3 python3-pip

# 验证安装
git --version
python3 --version
pip3 --version
```

#### 3. 克隆代码（首次部署）

```bash
cd /opt
git clone https://github.com/xingdong23/zhixing_trader.git
cd zhixing_trader
```

#### 4. 安装Python依赖

```bash
cd /opt/zhixing_trader/bitcoin_trader
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 5. 配置环境变量

```bash
cd /opt/zhixing_trader/bitcoin_trader

# 创建 .env 文件
cat > .env << 'EOF'
# OKX API 配置
OKX_API_KEY=your_api_key_here
OKX_API_SECRET=your_api_secret_here
OKX_PASSPHRASE=your_passphrase_here

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=shuzhongren
DB_NAME=bitcoin_trader

# 日志配置
LOG_LEVEL=INFO
EOF

# 编辑配置文件，填入真实的OKX API信息
vim .env
```

#### 6. 创建日志目录

```bash
mkdir -p /opt/zhixing_trader/bitcoin_trader/logs
```

#### 7. 测试运行

```bash
cd /opt/zhixing_trader/bitcoin_trader

# 测试策略集成
python3 test_strategy_integration.py

# 测试EMA策略
python3 test_ema_strategy.py
```

#### 8. 配置systemd服务

```bash
# 创建服务文件
cat > /etc/systemd/system/bitcoin-trader.service << 'EOF'
[Unit]
Description=Bitcoin Trader - EMA Trend Strategy
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/zhixing_trader/bitcoin_trader
ExecStart=/usr/bin/python3 /opt/zhixing_trader/bitcoin_trader/run_okx_live_demo.py
Restart=on-failure
RestartSec=10
StandardOutput=append:/opt/zhixing_trader/bitcoin_trader/logs/trader.log
StandardError=append:/opt/zhixing_trader/bitcoin_trader/logs/trader.error.log
Environment="PYTHONUNBUFFERED=1"

[Install]
WantedBy=multi-user.target
EOF

# 重载systemd
systemctl daemon-reload
```

---

## 🎮 服务管理命令

### 启动服务

```bash
systemctl start bitcoin-trader
```

### 查看状态

```bash
systemctl status bitcoin-trader
```

### 停止服务

```bash
systemctl stop bitcoin-trader
```

### 重启服务

```bash
systemctl restart bitcoin-trader
```

### 设置开机自启

```bash
systemctl enable bitcoin-trader
```

### 取消开机自启

```bash
systemctl disable bitcoin-trader
```

---

## 📊 日志查看

### 查看实时日志

```bash
tail -f /opt/zhixing_trader/bitcoin_trader/logs/trader.log
```

### 查看错误日志

```bash
tail -f /opt/zhixing_trader/bitcoin_trader/logs/trader.error.log
```

### 查看systemd日志

```bash
journalctl -u bitcoin-trader -f
```

### 查看最近100行日志

```bash
tail -n 100 /opt/zhixing_trader/bitcoin_trader/logs/trader.log
```

---

## 🔄 代码更新流程

### 1. 在本地修改代码

```bash
# 在本地修改代码后
cd /Users/chengzheng/workspace/chuangxin/zhixing_trader

# 提交到git
git add .
git commit -m "更新说明"
git push origin main
```

### 2. 在服务器上更新

```bash
# SSH连接到服务器
ssh root@101.42.14.209

# 停止服务
systemctl stop bitcoin-trader

# 拉取最新代码
cd /opt/zhixing_trader
git pull origin main

# 如果有新的依赖，重新安装
cd bitcoin_trader
pip3 install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 重启服务
systemctl start bitcoin-trader

# 查看状态
systemctl status bitcoin-trader
```

---

## 🔍 故障排查

### 1. 服务启动失败

```bash
# 查看详细错误信息
systemctl status bitcoin-trader
journalctl -u bitcoin-trader -n 50

# 检查配置文件
cat /opt/zhixing_trader/bitcoin_trader/.env

# 手动运行测试
cd /opt/zhixing_trader/bitcoin_trader
python3 run_okx_live_demo.py
```

### 2. 网络连接问题

```bash
# 测试网络连接
ping www.okx.com
curl https://www.okx.com

# 检查防火墙
systemctl status firewalld
```

### 3. Python依赖问题

```bash
# 重新安装依赖
cd /opt/zhixing_trader/bitcoin_trader
pip3 install -r requirements.txt --force-reinstall -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 4. 数据库连接问题

```bash
# 测试MySQL连接
mysql -uroot -pshuzhongren

# 检查MySQL服务
systemctl status mysqld
```

---

## 📝 配置文件说明

### .env 配置项

```bash
# OKX API配置（必须）
OKX_API_KEY=your_api_key          # OKX API Key
OKX_API_SECRET=your_secret        # OKX API Secret
OKX_PASSPHRASE=your_passphrase    # OKX API Passphrase

# 数据库配置
DB_HOST=localhost                 # 数据库地址
DB_PORT=3306                      # 数据库端口
DB_USER=root                      # 数据库用户
DB_PASSWORD=shuzhongren           # 数据库密码
DB_NAME=bitcoin_trader            # 数据库名称

# 日志配置
LOG_LEVEL=INFO                    # 日志级别: DEBUG/INFO/WARNING/ERROR
```

---

## 🎯 当前策略配置

**策略**: EMA趋势跟随策略

**参数**:
- EMA周期: 8/21/55
- 仓位: 30%
- 最大亏损: 4%
- 止盈目标: 5%/10%/15%
- 时间周期: 5分钟
- 检查间隔: 30秒

**风险控制**:
- 最大仓位: 0.05 BTC
- 单笔最大: 2000 USDT
- 日亏损限制: 5%

---

## ⚠️ 重要提示

1. **API密钥安全**
   - 不要在代码中硬编码API密钥
   - 使用.env文件管理敏感信息
   - 定期更换API密钥

2. **风险控制**
   - 初期使用小仓位测试
   - 严格遵守止损规则
   - 定期检查交易记录

3. **监控告警**
   - 定期查看日志
   - 监控服务运行状态
   - 设置异常告警

4. **代码管理**
   - 所有修改必须在本地完成
   - 提交到git后再部署
   - 不要直接在服务器修改代码

---

## 📞 快速命令参考

```bash
# 连接服务器
ssh root@101.42.14.209

# 查看服务状态
systemctl status bitcoin-trader

# 查看实时日志
tail -f /opt/zhixing_trader/bitcoin_trader/logs/trader.log

# 更新代码
cd /opt/zhixing_trader && git pull origin main

# 重启服务
systemctl restart bitcoin-trader

# 编辑配置
vim /opt/zhixing_trader/bitcoin_trader/.env
```

---

**部署完成后，记得配置OKX API密钥！** 🔑
