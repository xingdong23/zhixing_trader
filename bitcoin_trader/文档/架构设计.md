# 比特币交易系统架构文档

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端 (可选)                          │
│                  React / Vue.js                         │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTP/WebSocket
┌─────────────────▼───────────────────────────────────────┐
│                  API Gateway (FastAPI)                   │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │  行情   │  │  交易   │  │  策略   │  │  回测   │   │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                   业务逻辑层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 交易所管理器  │  │  策略引擎    │  │  风险控制    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  数据采集    │  │  回测引擎    │  │  订单管理    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────┬───────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                   数据访问层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │   MySQL      │  │    Redis     │  │  RabbitMQ    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└───────────────────────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────┐
│                外部服务 (交易所)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ Binance  │  │   OKX    │  │  Bybit   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└───────────────────────────────────────────────────────────┘
```

### 核心模块

#### 1. API层 (app/api)
- **行情API**: 获取实时行情、K线数据、订单簿
- **交易API**: 下单、撤单、查询订单、持仓查询
- **策略API**: 策略管理、启动停止策略
- **回测API**: 运行回测、查询回测结果

#### 2. 核心业务层 (app/core)

##### 交易所管理 (exchanges/)
- 统一的交易所接口
- 支持多交易所切换
- API密钥管理
- 错误处理和重试

##### 策略引擎 (strategies/)
- 策略基类定义
- 内置策略实现
- 自定义策略支持
- 策略参数管理

##### 回测引擎 (backtest/)
- 历史数据回测
- 性能指标计算
- 回测报告生成

##### 风险管理 (risk/)
- 仓位控制
- 止损止盈
- 最大回撤监控
- 资金管理

#### 3. 数据模型 (app/models)
- K线数据模型
- 订单模型
- 持仓模型
- 策略模型
- 回测结果模型

#### 4. 服务层 (app/services)
- 数据采集服务
- 订单执行服务
- 策略运行服务
- 告警服务

#### 5. 数据访问层 (app/repositories)
- 数据库操作封装
- 缓存管理

## 数据流

### 1. 行情数据流

```
交易所 WebSocket → 数据采集服务 → 数据验证 → 存储到MySQL
                                    ↓
                                Redis缓存 → 策略引擎
```

### 2. 交易执行流

```
策略信号 → 风险检查 → 订单生成 → 交易所API → 订单确认
                                         ↓
                                    更新持仓/订单状态
```

### 3. 回测流程

```
历史数据 → 回测引擎 → 策略执行 → 性能计算 → 结果存储
```

## 技术选型

### 后端技术
- **Web框架**: FastAPI (高性能异步框架)
- **数据库**: MySQL (持久化存储)
- **缓存**: Redis (实时数据缓存)
- **任务队列**: Celery + RabbitMQ (异步任务)
- **交易所API**: CCXT (统一的交易所接口)

### 数据分析
- **pandas**: 数据处理
- **numpy**: 数值计算
- **ta-lib**: 技术指标计算

### 回测
- **backtrader**: 回测框架

## 部署架构

### 开发环境
```
本地开发 → 本地MySQL → 本地Redis
```

### 生产环境
```
                    ┌─────────────┐
                    │   Nginx     │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
    ┌───────▼──────┐ ┌────▼─────┐ ┌─────▼──────┐
    │  API Server  │ │  Worker  │ │  Scheduler │
    │   (主进程)    │ │ (策略)   │ │  (定时任务) │
    └───────┬──────┘ └────┬─────┘ └─────┬──────┘
            │              │              │
            └──────────────┼──────────────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
    ┌───────▼──────┐ ┌────▼─────┐ ┌─────▼──────┐
    │    MySQL     │ │  Redis   │ │ RabbitMQ   │
    └──────────────┘ └──────────┘ └────────────┘
```

## 安全考虑

1. **API密钥安全**
   - 环境变量存储
   - 加密存储到数据库
   - 不在日志中输出

2. **访问控制**
   - API Token认证
   - IP白名单
   - 请求频率限制

3. **风险控制**
   - 最大持仓限制
   - 单笔交易限额
   - 异常交易告警

## 扩展性

### 水平扩展
- API服务可部署多实例
- 策略引擎可独立部署
- 使用消息队列解耦

### 功能扩展
- 插件式策略系统
- 支持新增交易所
- 自定义指标库

## 监控和告警

1. **系统监控**
   - API响应时间
   - 数据库连接
   - 交易所连接状态

2. **业务监控**
   - 策略运行状态
   - 持仓盈亏
   - 订单执行情况

3. **告警机制**
   - 邮件告警
   - Webhook告警
   - 日志记录

