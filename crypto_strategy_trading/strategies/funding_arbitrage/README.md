# OKX 资金费率套利全自动机器人

## 📊 策略简介

利用永续合约资金费率机制，通过**现货 + 合约对冲**涨跌，只吃每8小时结算的资金费率（多头或空头送的钱）。

当前（2025.11.18）ETH 资金费率处于低位/轻微负，正适合开机器人自动吃钱。

### 💰 收益预期

| 项目 | 数值 |
|------|------|
| **本金建议** | 50~300 USDT 起步 |
| **杠杆建议** | 1.5~2.0x（50 USDT建议1.8x） |
| **预期收益** | 当前低费率日赚0.1~0.5 USDT<br>费率回升后日赚0.5~2+ USDT |
| **风险等级** | ⭐ 极低（2x杠杆下爆仓需单边暴跌50%+） |

---

## 🎯 核心原理

| 资金费率 | 机器人仓位 | 你吃谁的钱 |
|---------|-----------|-----------|
| **正费率** | 现货持ETH + 合约做空（超额） | 💰 吃多头钱 |
| **负费率** | 现货卖USDT + 合约做多（超额） | 💰 吃空头钱 |

机器人每10分钟检查一次，实现**自动翻仓**，永远站在被付钱的一方。

---

## 🚀 快速开始

### 1. 配置API密钥

在项目根目录创建 `.env` 文件：

```bash
# OKX API配置
OKX_API_KEY=你的API Key
OKX_SECRET_KEY=你的Secret Key
OKX_PASSPHRASE=你的Passphrase
```

⚠️ **重要提示**：
- 首次使用请先在OKX模拟盘测试
- API权限只需要：**交易权限**（读取+交易）
- 建议设置IP白名单提高安全性

### 2. 修改配置文件

编辑 `strategies/funding_arbitrage/config.json`：

```json
{
  "symbol": "ETH-USDT",
  "check_interval": 600,
  "strategy_params": {
    "leverage": 1.8,
    "target_delta": 0.98,
    "funding_threshold": 0.0001
  },
  "telegram_token": "你的Telegram Bot Token",
  "telegram_chat_id": "你的chat_id"
}
```

**参数说明**：
- `leverage`: 杠杆倍数（50刀建议1.8，300刀可开到2.0）
- `target_delta`: 超额比例（0.98表示轻微超额吃更多费率）
- `funding_threshold`: 费率阈值（超过此值做空，否则做多）
- `check_interval`: 检查间隔（秒），默认600秒（10分钟）

### 3. 启动机器人

#### 模拟盘测试（强烈推荐）

```bash
# 方式1: 使用启动脚本
bash live_trading/start_funding_arbitrage.sh paper

# 方式2: 直接运行Python
python live_trading/funding_arbitrage.py --mode paper
```

#### 实盘运行（谨慎使用）

```bash
# ⚠️ 请先在模拟盘测试至少48小时！
bash live_trading/start_funding_arbitrage.sh live
```

---

## 📋 功能特性

### ✅ 核心功能

- [x] **自动监控资金费率** - 每10分钟检查一次
- [x] **自动调整仓位** - 现货+合约对冲
- [x] **自动翻仓** - 费率反转时自动切换方向
- [x] **风险控制** - 仓位偏差超5%自动调整
- [x] **完整日志** - 所有操作记录到日志文件

### 🔔 通知功能

- [x] Telegram通知（可选）
  - 每日运行状态
  - 费率反转提醒
  - 仓位调整通知
  - 错误告警

### 🛡️ 安全特性

- [x] 模拟盘/实盘分离
- [x] 实盘模式需要二次确认
- [x] API密钥环境变量管理
- [x] 异常自动重试

---

## 📊 监控与日志

### 查看日志

```bash
# 查看最新日志
tail -f logs/funding_arbitrage_paper_*.log

# 查看所有日志
ls -lt logs/funding_arbitrage_*.log
```

### 日志内容示例

```
2025-11-18 20:00:00 [INFO] 🤖 资金费率套利机器人启动
2025-11-18 20:00:00 [INFO] 模式: 🟢 模拟盘
2025-11-18 20:00:00 [INFO] 交易对: ETH-USDT
2025-11-18 20:00:00 [INFO] 杠杆: 1.8x
2025-11-18 20:00:00 [INFO] 🚀 开始运行，每600秒检查一次
2025-11-18 20:00:05 [INFO] 📊 当前价格: $3150.50, 资金费率: 0.0105%, 现货余额: 0.1000
2025-11-18 20:00:05 [INFO] ✓ 仓位平衡，资金费率: 0.0105%
```

### 停止机器人

```bash
# 方式1: Ctrl+C（推荐）
# 在运行终端按 Ctrl+C

# 方式2: 杀死进程
pkill -9 -f 'python.*funding_arbitrage'
```

---

## 🔧 配置Telegram通知（可选）

### 1. 创建Telegram Bot

1. 在Telegram搜索 `@BotFather`
2. 发送 `/newbot` 创建新机器人
3. 获取 `Bot Token`

### 2. 获取Chat ID

1. 在Telegram搜索 `@userinfobot`
2. 发送任意消息获取你的 `Chat ID`

### 3. 配置到config.json

```json
{
  "telegram_token": "你的Bot Token",
  "telegram_chat_id": "你的Chat ID"
}
```

---

## ⚠️ 风险提示

### 极低风险场景

✅ **正常情况**（99.9%时间）：
- 现货+合约完全对冲，价格涨跌不影响
- 只赚资金费率，风险极低
- 2x杠杆下爆仓需单边暴跌50%+（历史极少）

### 需要注意的情况

⚠️ **极端行情**：
- 单边暴涨/暴跌50%+（如黑天鹅事件）
- 交易所故障导致无法平仓
- API限流导致无法及时调整

⚠️ **操作风险**：
- 现货余额不足导致对冲失效
- 杠杆设置过高（>3x）
- 手动干预策略运行

### 风控建议

1. ✅ **先模拟盘测试48小时**
2. ✅ **小额资金起步**（50-300 USDT）
3. ✅ **杠杆不超过2x**
4. ✅ **保持充足保证金**
5. ✅ **定期检查日志**

---

## 📈 收益计算

### 资金费率说明

- **结算频率**：每8小时一次（00:00, 08:00, 16:00 UTC）
- **费率范围**：通常在 -0.05% ~ +0.05%
- **年化收益**：如果平均费率0.01%，年化约10.95%

### 收益示例

| 本金 | 杠杆 | 日均费率 | 日收益 | 月收益 | 年化收益 |
|------|------|---------|--------|--------|---------|
| 100 USDT | 1.8x | 0.01% | $0.18 | $5.4 | $65.7 (65.7%) |
| 300 USDT | 2.0x | 0.01% | $0.60 | $18.0 | $219 (73%) |
| 100 USDT | 1.8x | 0.03% | $0.54 | $16.2 | $197 (197%) |

*注：实际收益受费率波动影响，以上为理论计算*

---

## 🛠️ 故障排查

### 常见问题

#### 1. 无法启动

**问题**：提示找不到模块

**解决**：
```bash
# 检查虚拟环境
source .venv/bin/activate

# 安装依赖
pip install ccxt requests python-dotenv
```

#### 2. API连接失败

**问题**：无法连接OKX API

**解决**：
- 检查 `.env` 文件是否正确配置
- 验证API密钥是否有效
- 检查网络连接
- 确认OKX服务状态

#### 3. 无法获取资金费率

**问题**：资金费率始终为0

**解决**：
- 确认交易对正确（ETH-USDT-SWAP）
- 检查API权限
- 查看日志详细错误信息

#### 4. 仓位调整失败

**问题**：无法开仓或平仓

**解决**：
- 检查账户余额是否充足
- 确认杠杆设置是否合理
- 查看API限流情况

---

## 📚 技术架构

### 策略类

- `FundingArbitrageStrategy`: 策略核心逻辑
  - 资金费率分析
  - 仓位计算
  - 信号生成

### 运行器

- `FundingArbitrageBot`: 自动化交易机器人
  - 交易所连接
  - 订单执行
  - 日志记录
  - Telegram通知

### 配置文件

- `config.json`: 策略参数配置
- `.env`: API密钥配置

---

## 📝 更新日志

### v1.0.0 (2025-11-18)

- ✅ 初始版本发布
- ✅ 支持OKX永续合约
- ✅ 自动资金费率套利
- ✅ 自动翻仓功能
- ✅ Telegram通知
- ✅ 完整日志记录
- ✅ 模拟盘/实盘支持

---

## 💡 最佳实践

### 推荐配置

**50 USDT 起步**：
```json
{
  "leverage": 1.8,
  "target_delta": 0.98
}
```

**300 USDT 起步**：
```json
{
  "leverage": 2.0,
  "target_delta": 0.98
}
```

### 运行建议

1. **模拟盘测试**：至少运行48小时，观察策略行为
2. **小额起步**：实盘初期使用50-100 USDT
3. **定期检查**：每天查看日志，确认运行正常
4. **保持余额**：确保账户有充足的保证金
5. **监控费率**：关注资金费率变化趋势

---

## 📞 支持

- **文档**：查看本README
- **日志**：查看 `logs/` 目录
- **问题**：提交GitHub Issue

---

## 📄 许可证

MIT License

---

**最后更新**: 2025-11-18  
**版本**: v1.0.0  
**状态**: ✅ 可用于模拟盘测试
