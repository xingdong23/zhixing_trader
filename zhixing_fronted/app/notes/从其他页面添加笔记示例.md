# 从其他页面添加笔记 - 实现示例

## 概述

本文档展示如何在不同页面（股票列表、交易页面、策略页面）添加"快速添加笔记"功能，实现自动关联。

## 1. 在股票列表页添加笔记

### 场景
用户在股票列表浏览时，看到感兴趣的股票，想快速记录想法。

### 实现示例

```typescript
// components/stocks/StockCard.tsx
import { StickyNote } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useRouter } from "next/navigation";

interface StockCardProps {
  stock: {
    symbol: string;
    name: string;
    price: number;
    change: number;
  };
}

export function StockCard({ stock }: StockCardProps) {
  const router = useRouter();
  
  const handleAddNote = () => {
    // 方式1：跳转到笔记页面，带参数
    router.push(`/notes?type=stock&relatedId=${stock.symbol}&relatedLabel=${encodeURIComponent(stock.name)}`);
    
    // 方式2：直接打开对话框（需要在父组件管理状态）
    // onAddNote({ type: "stock", relatedId: stock.symbol, relatedLabel: stock.name });
  };
  
  return (
    <div className="stock-card">
      <h3>{stock.symbol} - {stock.name}</h3>
      <p>价格: ${stock.price}</p>
      <p>涨跌: {stock.change}%</p>
      
      <Button 
        variant="ghost" 
        size="sm" 
        onClick={handleAddNote}
        title="添加笔记"
      >
        <StickyNote className="w-4 h-4" />
      </Button>
    </div>
  );
}
```

### 笔记页面接收参数

```typescript
// app/notes/page.tsx
import { useSearchParams } from "next/navigation";
import { useEffect } from "react";

export default function NotesPage() {
  const searchParams = useSearchParams();
  const [showEditor, setShowEditor] = useState(false);
  const [initialNote, setInitialNote] = useState<Partial<Note> | null>(null);
  
  useEffect(() => {
    // 检查URL参数
    const type = searchParams.get("type") as NoteType | null;
    const relatedId = searchParams.get("relatedId");
    const relatedLabel = searchParams.get("relatedLabel");
    
    if (type && relatedId) {
      // 自动打开编辑器，预填信息
      setInitialNote({
        type,
        relatedId,
        relatedInfo: {
          type: type,
          label: relatedLabel || relatedId,
          link: type === "stock" ? `/stock/${relatedId}` : undefined,
        },
        title: `${relatedLabel || relatedId} - `,
        content: "",
        isStarred: false,
        tags: [],
      });
      setShowEditor(true);
    }
  }, [searchParams]);
  
  return (
    <div>
      {/* ... */}
      <NoteEditor
        note={initialNote || editingNote}
        open={showEditor}
        onClose={() => {
          setShowEditor(false);
          setInitialNote(null);
        }}
        onSave={handleSaveNote}
        // ...
      />
    </div>
  );
}
```

## 2. 在"我的交易"页面添加笔记

### 场景
用户完成一笔交易后，想记录交易复盘。

### 实现示例

```typescript
// components/trades/TradeCard.tsx
import { StickyNote } from "lucide-react";
import { Button } from "@/components/ui/button";

interface TradeCardProps {
  trade: {
    id: number;
    symbol: string;
    type: "buy" | "sell";
    price: number;
    quantity: number;
    profit?: number;
  };
  onAddNote: (trade: Trade) => void;
}

export function TradeCard({ trade, onAddNote }: TradeCardProps) {
  return (
    <div className="trade-card">
      <h3>{trade.symbol}</h3>
      <p>类型: {trade.type === "buy" ? "买入" : "卖出"}</p>
      <p>价格: ${trade.price}</p>
      <p>数量: {trade.quantity}</p>
      {trade.profit && <p>盈亏: ${trade.profit}</p>}
      
      <Button 
        variant="ghost" 
        size="sm" 
        onClick={() => onAddNote(trade)}
        title="添加交易笔记"
      >
        <StickyNote className="w-4 h-4" />
        添加笔记
      </Button>
    </div>
  );
}
```

### 父组件处理

```typescript
// app/trades/page.tsx
import { useRouter } from "next/navigation";

export default function TradesPage() {
  const router = useRouter();
  
  const handleAddNote = (trade: Trade) => {
    const noteData = {
      type: "trade",
      relatedId: trade.symbol, // 或者 trade.id
      relatedLabel: `${trade.symbol} ${trade.type === "buy" ? "买入" : "卖出"} ${trade.quantity}股 @${trade.price}`,
      title: `${trade.symbol} 交易复盘`,
    };
    
    // 跳转到笔记页面
    const params = new URLSearchParams({
      type: noteData.type,
      relatedId: noteData.relatedId,
      relatedLabel: noteData.relatedLabel,
      title: noteData.title,
    });
    
    router.push(`/notes?${params.toString()}`);
  };
  
  return (
    <div>
      {trades.map(trade => (
        <TradeCard 
          key={trade.id} 
          trade={trade} 
          onAddNote={handleAddNote}
        />
      ))}
    </div>
  );
}
```

## 3. 在策略页面添加笔记

### 场景
用户在研究某个策略时，想记录策略细节和优化想法。

### 实现示例

```typescript
// app/strategy/page.tsx
import { StickyNote } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useRouter } from "next/navigation";

export default function StrategyPage() {
  const router = useRouter();
  
  const strategies = [
    { id: "momentum_breakout", name: "动量突破策略" },
    { id: "mean_reversion", name: "均值回归策略" },
    { id: "trend_following", name: "趋势跟踪策略" },
  ];
  
  const handleAddStrategyNote = (strategy: { id: string; name: string }) => {
    router.push(`/notes?type=strategy&relatedId=${strategy.id}&relatedLabel=${encodeURIComponent(strategy.name)}`);
  };
  
  return (
    <div>
      <h1>策略管理</h1>
      
      {strategies.map(strategy => (
        <div key={strategy.id} className="strategy-card">
          <h3>{strategy.name}</h3>
          
          <Button 
            variant="outline" 
            size="sm"
            onClick={() => handleAddStrategyNote(strategy)}
          >
            <StickyNote className="w-4 h-4 mr-2" />
            添加策略笔记
          </Button>
        </div>
      ))}
    </div>
  );
}
```

## 4. 在股票详情页添加笔记

### 场景
用户查看股票K线图和详细信息时，想记录技术分析。

### 实现示例

```typescript
// app/stock/[symbol]/page.tsx
import { StickyNote, Camera } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useRouter } from "next/navigation";
import { useParams } from "next/navigation";

export default function StockDetailPage() {
  const router = useRouter();
  const params = useParams();
  const symbol = params.symbol as string;
  
  const handleAddNote = () => {
    router.push(`/notes?type=stock&relatedId=${symbol}&title=${encodeURIComponent(`${symbol} 技术分析`)}`);
  };
  
  const handleAddNoteWithScreenshot = async () => {
    // 可以实现截取当前K线图
    // 然后创建笔记并附带截图
    
    router.push(`/notes?type=stock&relatedId=${symbol}&withScreenshot=true`);
  };
  
  return (
    <div>
      <h1>{symbol} 详情</h1>
      
      <div className="actions">
        <Button onClick={handleAddNote}>
          <StickyNote className="w-4 h-4 mr-2" />
          添加笔记
        </Button>
        
        <Button onClick={handleAddNoteWithScreenshot}>
          <Camera className="w-4 h-4 mr-2" />
          截图并添加笔记
        </Button>
      </div>
      
      {/* K线图等内容 */}
    </div>
  );
}
```

## 5. 使用对话框模式（更流畅）

### 优点
- 无需页面跳转
- 用户体验更流畅
- 可以立即看到笔记添加结果

### 实现示例

```typescript
// 创建一个全局笔记对话框上下文
// context/NoteDialogContext.tsx
import { createContext, useContext, useState } from "react";
import NoteEditor from "@/components/notes/NoteEditor";

interface NoteDialogContextType {
  openNoteDialog: (initialData: Partial<Note>) => void;
}

const NoteDialogContext = createContext<NoteDialogContextType | null>(null);

export function NoteDialogProvider({ children }: { children: React.ReactNode }) {
  const [showDialog, setShowDialog] = useState(false);
  const [initialNote, setInitialNote] = useState<Partial<Note> | null>(null);
  
  const openNoteDialog = (initialData: Partial<Note>) => {
    setInitialNote(initialData);
    setShowDialog(true);
  };
  
  const handleSave = async (note: Note) => {
    // 调用API保存笔记
    await fetch("/api/notes", {
      method: "POST",
      body: JSON.stringify(note),
    });
    
    setShowDialog(false);
    // 显示成功提示
  };
  
  return (
    <NoteDialogContext.Provider value={{ openNoteDialog }}>
      {children}
      
      <NoteEditor
        note={initialNote}
        open={showDialog}
        onClose={() => setShowDialog(false)}
        onSave={handleSave}
        // ...其他props
      />
    </NoteDialogContext.Provider>
  );
}

export function useNoteDialog() {
  const context = useContext(NoteDialogContext);
  if (!context) {
    throw new Error("useNoteDialog must be used within NoteDialogProvider");
  }
  return context;
}
```

### 在任何组件中使用

```typescript
// components/stocks/StockCard.tsx
import { useNoteDialog } from "@/context/NoteDialogContext";

export function StockCard({ stock }: StockCardProps) {
  const { openNoteDialog } = useNoteDialog();
  
  const handleAddNote = () => {
    openNoteDialog({
      type: "stock",
      relatedId: stock.symbol,
      relatedInfo: {
        type: "stock",
        label: `${stock.symbol} - ${stock.name}`,
        link: `/stock/${stock.symbol}`,
      },
      title: `${stock.symbol} - `,
      content: "",
      isStarred: false,
      tags: [],
    });
  };
  
  return (
    <div className="stock-card">
      {/* ... */}
      <Button onClick={handleAddNote}>
        <StickyNote className="w-4 h-4" />
      </Button>
    </div>
  );
}
```

## 6. 完整的添加笔记流程

### 1. 用户操作
```
股票列表 → 点击"添加笔记"按钮
```

### 2. 预填信息
```typescript
{
  type: "stock",
  relatedId: "AAPL",
  relatedInfo: {
    type: "stock",
    label: "AAPL - 苹果公司",
    link: "/stock/AAPL"
  },
  title: "AAPL - ", // 用户可以继续输入
  content: "",
  isStarred: false,
  tags: []
}
```

### 3. 用户填写
- 补充标题
- 编写内容
- 选择标签
- 是否收藏

### 4. 保存
```typescript
// POST /api/notes
{
  type: "stock",
  title: "AAPL - 突破关键阻力位",
  content: "今天AAPL突破180美元...",
  relatedId: "AAPL",
  relatedInfo: { ... },
  tags: [{ id: 1, name: "看好" }, { id: 3, name: "技术分析" }],
  isStarred: false
}
```

### 5. 后续查看
- 在笔记列表可以看到该笔记
- 点击关联标签可以跳转到股票详情
- 在股票详情页可以看到所有相关笔记

## 7. 后端API建议

### 创建笔记
```typescript
POST /api/notes
Body: {
  type: "stock" | "market" | "trade" | "pattern" | "strategy" | "misc",
  title: string,
  content: string,
  relatedId?: string,
  relatedInfo?: {
    type: string,
    label: string,
    link?: string
  },
  tags: number[], // 标签ID数组
  isStarred: boolean
}
```

### 获取关联笔记
```typescript
GET /api/notes?type=stock&relatedId=AAPL
GET /api/notes?type=trade&relatedId=12345
GET /api/notes?type=strategy&relatedId=momentum_breakout
```

### 笔记统计
```typescript
GET /api/stocks/AAPL/notes/count
Response: { count: 5 }
```

---

**提示**: 建议优先使用"对话框模式"实现，用户体验最佳！

