# 🚀 系统联调测试指南

## ✅ 系统状态

### 当前运行状态
- **前端**: ✅ 运行中 http://localhost:3000
- **后端**: ✅ 运行中 http://localhost:8000  
- **数据库**: ✅ MySQL (448只股票)
- **新策略**: ✅ 已加载并可用

### 已实现的策略
1. ✅ EMA55回踩企稳策略 (ema55_pullback)
2. ✅ 均线缠绕策略 (ma_entanglement) **[新增]**
3. ✅ 龙头策略 (leader_strategy) **[新增]**

---

## 🧪 测试方法

### 方法1: 使用测试工具页面 (推荐新手)

1. **打开测试工具**
   ```bash
   open test_strategy.html
   # 或直接在浏览器中打开该文件
   ```

2. **功能说明**
   - 📊 系统状态检查: 验证前后端连接
   - 🎯 策略信息查看: 查看新策略的详细信息
   - 🔧 数据管理: 查看同步任务状态

### 方法2: 使用前端页面 (推荐)

1. **访问策略管理页面**
   ```
   http://localhost:3000/strategy
   ```

2. **测试新策略**
   
   a) **测试均线缠绕策略**
   - 在左侧策略列表中找到"均线缠绕突破策略"
   - 点击策略卡片查看详情
   - 点击"执行"按钮进行同步执行
   - 或点击"异步"按钮进行后台执行
   - 查看右侧的执行结果和选股推荐

   b) **测试龙头策略**
   - 在左侧策略列表中找到"龙头战法"
   - 点击策略卡片查看详情
   - 点击"执行"按钮
   - 查看筛选出的龙头股票

   c) **测试所有策略**
   - 点击顶部的"执行所有策略"按钮
   - 系统会依次执行所有启用的策略
   - 结果会合并显示

### 方法3: 使用API直接测试

1. **查看所有策略**
   ```bash
   curl http://localhost:8000/api/v1/strategies/ | python3 -m json.tool
   ```

2. **查看API文档**
   ```bash
   open http://localhost:8000/docs
   ```

3. **在Swagger UI中测试**
   - 访问 http://localhost:8000/docs
   - 找到策略相关的API端点
   - 点击"Try it out"进行测试

---

## 📊 新策略详解

### 1. 均线缠绕策略 (ma_entanglement)

**策略逻辑**:
- 检测5日、10日、20日均线缠绕形态
- 识别缠绕后的向上突破机会
- 成交量配合确认

**评分标准** (满分100):
| 指标 | 分数 | 说明 |
|------|------|------|
| 均线缠绕紧密度 | 0-30 | 三条均线距离越近分数越高 |
| 价格突破 | 0-40 | 突破所有均线得分最高 |
| 均线多头排列 | 0-20 | MA5>MA10>MA20 |
| 成交量放大 | 0-15 | 突破时放量确认 |
| 价格走势 | 0-10 | 近期上涨天数 |

**筛选条件**: 评分 ≥ 60分

### 2. 龙头策略 (leader_strategy)

**策略逻辑**:
- 识别板块或市场中的龙头股票
- 多维度综合评分
- 相对排名筛选

**评分标准** (满分100+):
| 指标 | 分数 | 说明 |
|------|------|------|
| 涨幅表现 | 0-55 | 5日/10日/20日涨幅 |
| 成交量放大 | 0-20 | 近期相对放量情况 |
| 连续上涨 | 0-20 | 连续上涨天数 |
| 创新高 | 0-15 | 60日新高突破能力 |
| 回撤控制 | 0-10 | 从高点回撤幅度 |
| 振幅稳定 | 0-10 | 日均振幅控制 |

**筛选条件**: 
- 评分 ≥ 60分
- 且在所有股票中排名前30%

---

## 🔍 调试技巧

### 1. 查看实时日志

```bash
# 后端日志
tail -f backend.dev.log

# 前端日志  
tail -f frontend.dev.log

# 只看策略相关日志
tail -f backend.dev.log | grep -E "策略|strategy"
```

### 2. 检查策略加载

```bash
# 查看最近的策略加载信息
tail -100 backend.dev.log | grep -E "注册策略|策略已加载"
```

### 3. 数据检查

```bash
# 检查股票数量
curl -s "http://localhost:8000/api/v1/stocks/overview?page=1&page_size=1" \
  | python3 -m json.tool | grep total

# 检查有数据的股票
tail -50 backend.dev.log | grep "有足够数据"
```

### 4. 常见问题排查

**问题1: 策略执行无结果**
- 检查数据库中是否有足够的K线数据
- 查看后端日志中的"有足够数据"消息
- 可能需要先进行数据同步

**问题2: 前端显示策略但无法执行**
- 检查后端服务是否正常运行
- 查看浏览器控制台的错误信息
- 检查网络请求是否成功

**问题3: 策略加载失败**
- 查看后端日志中的ERROR信息
- 检查策略文件是否正确创建
- 确认StrategyFactory中是否正确注册

---

## 📝 测试清单

### 基础测试
- [ ] 前后端服务都在运行
- [ ] 能访问前端页面 (http://localhost:3000)
- [ ] 能访问后端API (http://localhost:8000/docs)
- [ ] 策略列表中能看到新增的两个策略

### 功能测试
- [ ] 能在前端页面选择"均线缠绕策略"
- [ ] 点击执行按钮能正常运行
- [ ] 能看到策略执行结果
- [ ] 能在前端页面选择"龙头策略"
- [ ] 点击执行按钮能正常运行
- [ ] 能看到筛选出的龙头股票
- [ ] "执行所有策略"功能正常

### 数据测试
- [ ] 执行结果中包含评分信息
- [ ] 包含置信度、建议操作等字段
- [ ] 目标价和止损价计算正确
- [ ] 选股理由清晰明确

---

## 🎯 下一步

1. **如果一切正常**:
   - 开始使用新策略进行选股
   - 观察策略表现并调整参数
   - 记录选股结果用于回测

2. **如果发现问题**:
   - 查看后端日志定位错误
   - 检查数据质量和完整性
   - 根据错误信息调整策略参数

3. **优化建议**:
   - 根据实际选股效果调整评分权重
   - 添加更多筛选条件
   - 实现策略参数配置功能

---

## 📞 快速命令

```bash
# 查看系统状态
ps aux | grep -E "(python run.py|next)" | grep -v grep

# 重启后端
kill $(cat backend.dev.pid) && cd zhixing_backend && \
  export DATABASE_URL="mysql+pymysql://root:shuzhongren@101.42.14.209:3306/zhixing_trader" && \
  python run.py > ../backend.dev.log 2>&1 & echo $! > ../backend.dev.pid

# 查看策略列表
curl -s http://localhost:8000/api/v1/strategies/ | \
  python3 -m json.tool | jq '.data.strategies[] | {id, name, impl_type}'

# 查看最近日志
tail -30 backend.dev.log

# 打开测试工具
open test_strategy.html

# 打开前端策略页面
open http://localhost:3000/strategy

# 打开API文档
open http://localhost:8000/docs
```

---

## 💡 提示

- 新策略的评分算法已经过优化，可以根据实际效果进一步调整
- 建议先使用"异步执行"模式，避免阻塞浏览器
- 策略执行可能需要几秒到几十秒，取决于股票数量
- 可以在前端页面实时查看执行进度

祝调试顺利！🎉
