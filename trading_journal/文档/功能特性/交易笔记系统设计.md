# 📝 交易笔记系统设计方案

**参考**: [TradesViz Notes Tab](https://www.tradesviz.com/blog/notes-view/)  
**设计日期**: 2025-10-18  
**目标模块**: trading_journal

---

## 🎯 设计目标

打造一个专业的交易笔记管理系统，帮助交易者：
- 记录交易思考和复盘
- 管理日常交易日志
- 积累交易经验和教训
- 快速检索和回顾重要笔记

---

## 📊 核心功能规划

### 1. 笔记类型（3种）

#### 1.1 交易笔记 (Trade Note)
**场景**: 针对某笔具体交易的记录

**关联对象**: 交易记录 (Trade)

**典型内容**:
- 交易前分析：入场理由、技术形态、基本面分析
- 交易中观察：价格变化、情绪管理、仓位调整
- 交易后复盘：盈亏原因、操作得失、改进建议

**示例**:
```
交易: AAPL 买入 100股 @175.50
日期: 2024-10-15

入场理由:
- 突破月线阻力位
- MACD金叉
- 基本面支撑：Q3财报超预期

实际执行:
- 入场点位精准
- 但止损设置过紧，被扫出后继续上涨

教训:
- 需要给予更大的波动空间
- 下次类似情况考虑分批建仓
```

#### 1.2 日交易笔记 (Day Note)
**场景**: 记录某个交易日的整体情况

**关联对象**: 交易日期 (Trading Day)

**典型内容**:
- 市场观察：大盘走势、板块轮动
- 交易总结：当日盈亏、操作次数
- 情绪状态：心态变化、纪律执行
- 改进计划：下一步行动

**示例**:
```
日期: 2024-10-15

市场情况:
- 大盘震荡，科技股活跃
- 成交量萎缩

今日交易:
- 3笔交易，2胜1负
- 总盈利: +$520
- 最大回撤: -$180

心态:
- 早盘过于激进，追高被套
- 下午调整策略，等待回调买入

明日计划:
- 关注AI概念股
- 耐心等待更好的入场点
```

#### 1.3 杂项笔记 (Misc Note)
**场景**: 不关联具体交易或日期的通用笔记

**典型内容**:
- 策略研究：新策略的构思和测试
- 学习笔记：书籍、课程的学习记录
- 市场研判：中长期市场观点
- 交易想法：待验证的交易思路

**示例**:
```
标题: 龙头战法研究

核心思路:
1. 识别行业热点
2. 找出行业龙头
3. 等待回调买入
4. 止损：跌破5日线

待验证:
- 如何准确识别真假热点
- 龙头股的定量标准

下一步:
- 回测近3个月数据
- 建立选股模型
```

---

### 2. 笔记标签系统

#### 2.1 标签功能
**目的**: 对笔记进行分类管理

**设计**:
- 自定义标签名称
- 自定义标签颜色（8-10种颜色可选）
- 一个笔记可以打多个标签

#### 2.2 预设标签建议

**交易类型标签**:
- 🟢 日内交易 (Green)
- 🔵 波段交易 (Blue)
- 🟣 长期持有 (Purple)

**交易结果标签**:
- 🟢 盈利 (Green)
- 🔴 亏损 (Red)
- ⚪ 保本 (Gray)

**分析类型标签**:
- 🟡 技术分析 (Yellow)
- 🔵 基本面分析 (Blue)
- 🟣 情绪分析 (Purple)

**心态标签**:
- 🟢 纪律执行 (Green)
- 🟡 情绪波动 (Yellow)
- 🔴 违反纪律 (Red)

**重要程度标签**:
- 🔴 重要教训 (Red)
- 🟡 待验证 (Yellow)
- 🟢 成功案例 (Green)

---

### 3. 笔记编辑功能

#### 3.1 富文本编辑器
**功能清单**:
- ✅ 基础格式：加粗、斜体、下划线、删除线
- ✅ 标题：H1-H6 六级标题
- ✅ 列表：有序列表、无序列表
- ✅ 引用块
- ✅ 代码块（用于记录交易规则）
- ✅ 链接：插入外部链接
- ✅ 表格：用于对比分析
- ✅ 分隔线
- ✅ 文字颜色和背景色
- 🔄 图片上传（可选功能，V2开发）

**推荐编辑器**:
- **Quill** - 轻量级，易集成
- **Tiptap** - 基于ProseMirror，功能强大
- **Slate** - React生态，灵活度高

#### 3.2 编辑器工具栏
```
[B] [I] [U] [H1 ▼] [•••] [链接] [表格] [代码]
```

---

### 4. 笔记管理功能

#### 4.1 核心操作
- ✅ **创建笔记** - 新建笔记
- ✅ **编辑笔记** - 修改内容和标签
- ✅ **删除笔记** - 删除（需二次确认）
- ✅ **星标收藏** - 标记重要笔记
- ✅ **关联对象** - 关联到交易或日期

#### 4.2 批量操作
- 批量打标签
- 批量导出
- 批量删除

---

### 5. 搜索与过滤

#### 5.1 过滤选项
```
┌─────────────────────────────────────────┐
│ 📅 日期范围: [2024-10-01] 至 [2024-10-31] │
│                                         │
│ 📝 笔记类型:                             │
│   □ 全部笔记  ☑ 交易笔记  □ 日笔记  □ 杂项 │
│                                         │
│ 🏷️ 笔记标签:                             │
│   ☑ 盈利  □ 亏损  ☑ 技术分析  □ 基本面   │
│                                         │
│ ⭐ 收藏状态:                             │
│   ○ 全部  ● 仅收藏  ○ 未收藏            │
│                                         │
│ 🔍 关键词: [龙头战法___________]         │
│                                         │
│    [重置]  [应用过滤]                    │
└─────────────────────────────────────────┘
```

#### 5.2 全文搜索
- 搜索笔记标题
- 搜索笔记内容
- 高亮显示搜索结果
- 搜索历史记录

#### 5.3 排序选项
- 按创建时间（最新/最旧）
- 按修改时间
- 按关联日期
- 按标题字母顺序

---

### 6. 导出功能

#### 6.1 导出格式
- **Markdown** - 便于其他工具编辑
- **HTML** - 保留格式，可打印
- **PDF** - 正式归档
- **JSON** - 数据备份

#### 6.2 导出范围
- 导出单条笔记
- 导出筛选结果
- 导出全部笔记
- 导出指定日期范围

#### 6.3 导出选项
```
导出格式: ○ Markdown  ● HTML  ○ PDF
导出范围: ● 当前筛选 (23条)  ○ 全部笔记
包含内容: ☑ 标签  ☑ 关联信息  ☑ 创建时间
文件命名: [交易笔记_2024-10-18]
         [导出]  [取消]
```

---

## 💾 数据库设计

### 表结构设计

#### 1. notes (笔记主表)
```sql
CREATE TABLE notes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    
    -- 笔记类型
    note_type ENUM('trade', 'day', 'misc') NOT NULL,
    
    -- 关联对象
    trade_id BIGINT NULL,              -- 关联的交易ID
    trade_date DATE NULL,               -- 关联的交易日期
    
    -- 笔记内容
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,              -- 富文本内容
    
    -- 状态
    is_starred BOOLEAN DEFAULT FALSE,   -- 是否星标
    is_deleted BOOLEAN DEFAULT FALSE,   -- 软删除
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 索引
    INDEX idx_user_type (user_id, note_type),
    INDEX idx_trade (trade_id),
    INDEX idx_date (trade_date),
    INDEX idx_starred (user_id, is_starred),
    INDEX idx_created (created_at),
    
    -- 全文搜索（MySQL 5.7+）
    FULLTEXT INDEX ft_title_content (title, content)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2. note_tags (笔记标签表)
```sql
CREATE TABLE note_tags (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    
    -- 标签信息
    tag_name VARCHAR(50) NOT NULL,
    tag_color VARCHAR(20) NOT NULL,      -- hex color code
    
    -- 使用统计
    usage_count INT DEFAULT 0,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    UNIQUE INDEX uk_user_tag (user_id, tag_name),
    INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 3. note_tag_relations (笔记-标签关系表)
```sql
CREATE TABLE note_tag_relations (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    note_id BIGINT NOT NULL,
    tag_id INT NOT NULL,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 索引
    UNIQUE INDEX uk_note_tag (note_id, tag_id),
    INDEX idx_tag (tag_id),
    
    FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES note_tags(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 🎨 界面设计

### 1. 笔记列表页

```
┌────────────────────────────────────────────────────────────┐
│  📝 交易笔记                                   [+ 新建笔记]  │
├────────────────────────────────────────────────────────────┤
│  🔍 搜索: [_________________]  🏷️ [标签过滤▼]  ⭐ [仅收藏]  │
│  📅 日期: [2024-10-01] ~ [2024-10-31]    📊 类型: [全部▼]  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────────────────────────────────────────┐     │
│  │ ⭐ AAPL 突破月线阻力位买入              [交易笔记]  │     │
│  │ 🟢 盈利  🟡 技术分析                               │     │
│  │                                                    │     │
│  │ 入场理由：突破月线阻力位，MACD金叉...              │     │
│  │                                                    │     │
│  │ 2024-10-15 14:30  |  关联: AAPL #12345             │     │
│  │ [📝 编辑] [🗑️ 删除] [🔗 查看交易]                  │     │
│  └──────────────────────────────────────────────────┘     │
│                                                            │
│  ┌──────────────────────────────────────────────────┐     │
│  │ 大盘震荡，科技股活跃                    [日笔记]  │     │
│  │ 🟢 纪律执行  🟡 波段交易                           │     │
│  │                                                    │     │
│  │ 市场情况：大盘震荡，科技股活跃...                 │     │
│  │ 今日交易：3笔交易，2胜1负...                      │     │
│  │                                                    │     │
│  │ 2024-10-15  |  关联: 2024-10-15 交易日            │     │
│  │ [📝 编辑] [🗑️ 删除] [📅 查看当日]                  │     │
│  └──────────────────────────────────────────────────┘     │
│                                                            │
│  ┌──────────────────────────────────────────────────┐     │
│  │   龙头战法研究                          [杂项笔记]  │     │
│  │ 🟡 待验证  🔵 策略研究                              │     │
│  │                                                    │     │
│  │ 核心思路：1. 识别行业热点...                       │     │
│  │                                                    │     │
│  │ 2024-10-12 09:15                                   │     │
│  │ [📝 编辑] [🗑️ 删除] [🔗 关联到交易]                │     │
│  └──────────────────────────────────────────────────┘     │
│                                                            │
│  ← 上一页  1 / 5  下一页 →          每页显示: [20▼]       │
└────────────────────────────────────────────────────────────┘
```

### 2. 笔记编辑器

```
┌────────────────────────────────────────────────────────────┐
│  📝 编辑笔记                           [保存] [取消] [删除]  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  笔记类型: ● 交易笔记  ○ 日笔记  ○ 杂项笔记                │
│                                                            │
│  关联对象: [选择交易▼]  AAPL 买入 100股 @175.50            │
│                                                            │
│  标题: [AAPL 突破月线阻力位买入___________________]         │
│                                                            │
│  标签: [+ 添加标签]                                        │
│    🟢 盈利  🟡 技术分析  ✕                                  │
│                                                            │
│  ─────────────────────────────────────────────────────    │
│  [B] [I] [U] [H1▼] [•••] [链接] [表格] [代码]  ⭐ 星标     │
│  ─────────────────────────────────────────────────────    │
│                                                            │
│  ## 入场理由                                               │
│                                                            │
│  - 突破月线阻力位                                          │
│  - MACD金叉                                                │
│  - 基本面支撑：Q3财报超预期                                │
│                                                            │
│  ## 实际执行                                               │
│                                                            │
│  入场点位精准，但止损设置过紧...                           │
│                                                            │
│  _光标_                                                     │
│                                                            │
│                                                            │
│  ─────────────────────────────────────────────────────    │
│  字数: 156  |  最后保存: 刚刚                              │
└────────────────────────────────────────────────────────────┘
```

### 3. 标签管理弹窗

```
┌──────────────────────────────────────┐
│  🏷️ 管理笔记标签              [✕ 关闭]  │
├──────────────────────────────────────┤
│                                      │
│  [+ 新建标签]        🔍 [搜索______]  │
│                                      │
│  ┌────────────────────────────────┐  │
│  │ 🟢 盈利             使用: 23次   │  │
│  │ [编辑] [删除]                    │  │
│  ├────────────────────────────────┤  │
│  │ 🔴 亏损             使用: 12次   │  │
│  │ [编辑] [删除]                    │  │
│  ├────────────────────────────────┤  │
│  │ 🟡 技术分析         使用: 45次   │  │
│  │ [编辑] [删除]                    │  │
│  ├────────────────────────────────┤  │
│  │ 🔵 基本面分析       使用: 18次   │  │
│  │ [编辑] [删除]                    │  │
│  └────────────────────────────────┘  │
│                                      │
│  显示 4 / 12 个标签                   │
└──────────────────────────────────────┘
```

---

## 🚀 API 设计

### 1. 笔记 CRUD

#### 1.1 创建笔记
```http
POST /api/v1/notes
Content-Type: application/json

{
  "note_type": "trade",
  "trade_id": 12345,
  "title": "AAPL 突破月线阻力位买入",
  "content": "<h2>入场理由</h2><ul><li>突破月线阻力位</li></ul>",
  "is_starred": false,
  "tag_ids": [1, 3, 5]
}

Response: 201 Created
{
  "id": 789,
  "note_type": "trade",
  "title": "AAPL 突破月线阻力位买入",
  "created_at": "2024-10-18T10:30:00Z"
}
```

#### 1.2 获取笔记列表
```http
GET /api/v1/notes?
  note_type=trade&
  is_starred=false&
  tag_ids=1,3&
  start_date=2024-10-01&
  end_date=2024-10-31&
  search=AAPL&
  page=1&
  per_page=20&
  sort_by=created_at&
  sort_order=desc

Response: 200 OK
{
  "total": 45,
  "page": 1,
  "per_page": 20,
  "notes": [
    {
      "id": 789,
      "note_type": "trade",
      "trade_id": 12345,
      "title": "AAPL 突破月线阻力位买入",
      "content": "<h2>入场理由</h2>...",
      "is_starred": false,
      "tags": [
        {"id": 1, "name": "盈利", "color": "#10b981"},
        {"id": 3, "name": "技术分析", "color": "#f59e0b"}
      ],
      "trade": {
        "symbol": "AAPL",
        "action": "BUY",
        "quantity": 100
      },
      "created_at": "2024-10-18T10:30:00Z",
      "updated_at": "2024-10-18T10:35:00Z"
    }
  ]
}
```

#### 1.3 更新笔记
```http
PUT /api/v1/notes/{note_id}
Content-Type: application/json

{
  "title": "AAPL 突破月线阻力位买入（已平仓）",
  "content": "<h2>入场理由</h2>...<h2>平仓总结</h2>...",
  "is_starred": true,
  "tag_ids": [1, 3, 5, 7]
}

Response: 200 OK
```

#### 1.4 删除笔记
```http
DELETE /api/v1/notes/{note_id}

Response: 204 No Content
```

#### 1.5 切换星标状态
```http
POST /api/v1/notes/{note_id}/toggle-star

Response: 200 OK
{
  "is_starred": true
}
```

### 2. 标签管理

#### 2.1 创建标签
```http
POST /api/v1/note-tags
Content-Type: application/json

{
  "tag_name": "重要教训",
  "tag_color": "#ef4444"
}

Response: 201 Created
{
  "id": 15,
  "tag_name": "重要教训",
  "tag_color": "#ef4444",
  "usage_count": 0
}
```

#### 2.2 获取标签列表
```http
GET /api/v1/note-tags

Response: 200 OK
[
  {
    "id": 1,
    "tag_name": "盈利",
    "tag_color": "#10b981",
    "usage_count": 23
  },
  {
    "id": 2,
    "tag_name": "亏损",
    "tag_color": "#ef4444",
    "usage_count": 12
  }
]
```

#### 2.3 更新标签
```http
PUT /api/v1/note-tags/{tag_id}
Content-Type: application/json

{
  "tag_name": "盈利交易",
  "tag_color": "#10b981"
}

Response: 200 OK
```

#### 2.4 删除标签
```http
DELETE /api/v1/note-tags/{tag_id}

Response: 204 No Content
```

### 3. 导出功能

#### 3.1 导出笔记
```http
POST /api/v1/notes/export
Content-Type: application/json

{
  "format": "html",              // markdown, html, pdf, json
  "note_ids": [789, 790, 791],  // 空数组表示全部
  "include_tags": true,
  "include_relations": true
}

Response: 200 OK
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="trading_notes_2024-10-18.html"
```

### 4. 搜索功能

#### 4.1 全文搜索
```http
GET /api/v1/notes/search?
  q=龙头战法&
  note_type=misc&
  page=1&
  per_page=10

Response: 200 OK
{
  "total": 5,
  "results": [
    {
      "id": 792,
      "title": "龙头战法研究",
      "excerpt": "核心思路：1. 识别行业热点 2. 找出行业<em>龙头</em>...",
      "score": 0.95
    }
  ]
}
```

---

## 📱 前端组件设计

### 组件结构

```
components/notes/
├── NotesList.tsx           # 笔记列表容器
├── NoteCard.tsx            # 单个笔记卡片
├── NoteEditor.tsx          # 笔记编辑器
├── NoteFilters.tsx         # 过滤器组件
├── NoteTagManager.tsx      # 标签管理
├── NoteTagSelector.tsx     # 标签选择器
├── NoteSearch.tsx          # 搜索组件
└── NoteExport.tsx          # 导出功能组件
```

### 关键组件实现

#### NoteEditor.tsx (核心编辑器)
```typescript
import { useQuill } from 'react-quilljs';
import 'quill/dist/quill.snow.css';

interface NoteEditorProps {
  initialContent?: string;
  onSave: (content: string) => void;
}

export default function NoteEditor({ initialContent, onSave }: NoteEditorProps) {
  const { quill, quillRef } = useQuill({
    modules: {
      toolbar: [
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'header': [1, 2, 3, false] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['blockquote', 'code-block'],
        ['link'],
        [{ 'color': [] }, { 'background': [] }],
        ['clean']
      ]
    },
    theme: 'snow'
  });

  const handleSave = () => {
    if (quill) {
      const content = quill.root.innerHTML;
      onSave(content);
    }
  };

  return (
    <div>
      <div ref={quillRef} />
      <button onClick={handleSave}>保存</button>
    </div>
  );
}
```

---

## 🎯 实施计划

### Phase 1: 基础功能（2周）
- [x] 数据库表设计和创建
- [ ] 后端API开发
  - [ ] 笔记CRUD
  - [ ] 标签管理
- [ ] 前端基础页面
  - [ ] 笔记列表页
  - [ ] 简单文本编辑器

### Phase 2: 核心功能（2周）
- [ ] 富文本编辑器集成
- [ ] 笔记类型关联
  - [ ] 关联交易
  - [ ] 关联日期
- [ ] 标签系统完善
  - [ ] 标签管理界面
  - [ ] 标签过滤

### Phase 3: 高级功能（2周）
- [ ] 搜索功能
  - [ ] 全文搜索
  - [ ] 高级过滤
- [ ] 星标收藏
- [ ] 导出功能
  - [ ] Markdown导出
  - [ ] HTML导出

### Phase 4: 优化增强（1周）
- [ ] 性能优化
- [ ] 移动端适配
- [ ] 快捷键支持
- [ ] 实时自动保存

---

## 💡 特色功能建议

### 1. 智能提醒
**场景**: 帮助用户养成记笔记的习惯

**功能**:
- 交易完成后提醒写交易笔记
- 交易日结束提醒写日笔记
- 连续3天未写笔记提醒

### 2. 笔记模板
**场景**: 快速创建结构化笔记

**预设模板**:
- 交易复盘模板
- 策略研究模板
- 学习笔记模板
- 市场观察模板

### 3. 笔记统计
**场景**: 了解笔记使用情况

**统计指标**:
- 总笔记数、本月新增
- 各类型笔记占比
- 最常用的标签
- 笔记字数统计

### 4. 笔记关联分析
**场景**: 发现笔记间的联系

**功能**:
- 相似笔记推荐
- 相关交易推荐
- 标签共现分析

### 5. 笔记分享（可选）
**场景**: 团队协作或社区交流

**功能**:
- 生成分享链接
- 设置查看权限
- 评论和讨论

---

## 🎨 界面主题建议

### 配色方案
```css
/* 标签颜色预设 */
--tag-green: #10b981;    /* 盈利、成功 */
--tag-red: #ef4444;      /* 亏损、警告 */
--tag-blue: #3b82f6;     /* 分析、信息 */
--tag-yellow: #f59e0b;   /* 待验证、提醒 */
--tag-purple: #8b5cf6;   /* 策略、重要 */
--tag-gray: #6b7280;     /* 中性、其他 */
--tag-orange: #f97316;   /* 高优先级 */
--tag-pink: #ec4899;     /* 特殊标记 */
```

### 响应式设计
- **桌面端**: 三栏布局（过滤器 | 列表 | 预览）
- **平板**: 两栏布局（列表 | 详情）
- **移动端**: 单栏布局，全屏编辑

---

## 📊 成功指标

### 用户参与度
- 笔记创建率：交易完成后 > 50% 创建笔记
- 活跃用户：每周至少创建 1 条笔记
- 笔记平均字数：> 100 字

### 功能使用率
- 标签使用率：> 80% 的笔记带标签
- 星标使用率：> 20% 的笔记被星标
- 搜索使用率：用户平均每周搜索 > 2 次

### 系统性能
- 笔记加载速度：< 500ms
- 搜索响应时间：< 300ms
- 编辑器流畅度：无明显卡顿

---

## 🔐 安全性考虑

1. **数据隔离**: 严格的用户级别数据隔离
2. **权限控制**: 只能访问自己的笔记
3. **XSS防护**: 富文本内容需要过滤
4. **备份机制**: 定期备份笔记数据
5. **软删除**: 删除笔记保留30天恢复期

---

## 📚 参考资源

- [TradesViz Notes Feature](https://www.tradesviz.com/blog/notes-view/)
- [Quill Editor](https://quilljs.com/)
- [Tiptap Editor](https://tiptap.dev/)
- [Evernote Design](https://evernote.com/)
- [Notion Templates](https://www.notion.so/templates)

---

**设计完成**: 2025-10-18  
**下一步**: 开始 Phase 1 数据库设计和API开发

