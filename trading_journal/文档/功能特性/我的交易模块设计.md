# 我的交易模块设计方案

## 1. 功能概述

"我的交易"是交易日志系统的核心模块，用于管理完整的交易生命周期。

### 1.1 核心功能

1. **正在交易**：显示当前持仓的交易，实时跟踪盈亏
2. **历史交易记录**：已平仓的交易历史，支持分析和复盘
3. **等待执行的交易计划**：待触发的交易计划，支持提醒和监控

### 1.2 交易生命周期

```
交易计划 → 等待执行 → 开仓 → 持仓中 → 平仓 → 历史记录
   ↓          ↓          ↓         ↓        ↓
  笔记      提醒      笔记      笔记     复盘笔记
  截图      截图      截图      截图      总结
  思路      思路      调整      调整      经验
```

## 2. 数据库设计

### 2.1 交易表 (trades)

```sql
CREATE TABLE trades (
    id INT PRIMARY KEY AUTO_INCREMENT,
    
    -- 基本信息
    symbol VARCHAR(20) NOT NULL COMMENT '股票代码',
    stock_name VARCHAR(100) COMMENT '股票名称',
    
    -- 交易状态
    status ENUM('planned', 'pending', 'active', 'closed', 'cancelled') NOT NULL DEFAULT 'planned' COMMENT '交易状态',
    
    -- 计划阶段
    plan_type ENUM('long', 'short') NOT NULL COMMENT '交易方向：做多/做空',
    plan_entry_price DECIMAL(10, 2) COMMENT '计划入场价格',
    plan_entry_price_range_low DECIMAL(10, 2) COMMENT '入场价格区间-低',
    plan_entry_price_range_high DECIMAL(10, 2) COMMENT '入场价格区间-高',
    plan_quantity INT COMMENT '计划交易数量',
    plan_stop_loss DECIMAL(10, 2) COMMENT '计划止损价',
    plan_take_profit DECIMAL(10, 2) COMMENT '计划止盈价',
    plan_notes TEXT COMMENT '计划阶段笔记',
    plan_strategy TEXT COMMENT '交易策略/思路',
    plan_created_at DATETIME COMMENT '计划创建时间',
    
    -- 执行阶段
    entry_price DECIMAL(10, 2) COMMENT '实际入场价格',
    entry_time DATETIME COMMENT '入场时间',
    entry_quantity INT COMMENT '实际入场数量',
    entry_notes TEXT COMMENT '入场笔记',
    
    -- 持仓阶段
    current_price DECIMAL(10, 2) COMMENT '当前价格',
    current_quantity INT COMMENT '当前持仓数量',
    unrealized_pnl DECIMAL(10, 2) COMMENT '浮动盈亏',
    unrealized_pnl_pct DECIMAL(5, 2) COMMENT '浮动盈亏百分比',
    
    -- 平仓阶段
    exit_price DECIMAL(10, 2) COMMENT '平仓价格',
    exit_time DATETIME COMMENT '平仓时间',
    exit_quantity INT COMMENT '平仓数量',
    exit_notes TEXT COMMENT '平仓笔记',
    
    -- 交易结果
    realized_pnl DECIMAL(10, 2) COMMENT '已实现盈亏',
    realized_pnl_pct DECIMAL(5, 2) COMMENT '已实现盈亏百分比',
    commission DECIMAL(10, 2) DEFAULT 0 COMMENT '手续费',
    net_pnl DECIMAL(10, 2) COMMENT '净盈亏',
    
    -- 止损止盈
    stop_loss_price DECIMAL(10, 2) COMMENT '止损价',
    take_profit_price DECIMAL(10, 2) COMMENT '止盈价',
    stop_loss_updated_at DATETIME COMMENT '止损更新时间',
    
    -- 复盘
    review_rating TINYINT COMMENT '交易评分(1-5)',
    review_notes TEXT COMMENT '复盘笔记',
    review_lessons TEXT COMMENT '经验教训',
    review_tags VARCHAR(500) COMMENT '复盘标签(JSON数组)',
    
    -- 关联
    strategy_id INT COMMENT '关联的策略ID',
    category_id INT COMMENT '关联的分类ID',
    
    -- 元数据
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME COMMENT '软删除时间',
    
    INDEX idx_symbol (symbol),
    INDEX idx_status (status),
    INDEX idx_entry_time (entry_time),
    INDEX idx_exit_time (exit_time),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='交易记录表';
```

### 2.2 交易笔记关联表 (trade_notes)

```sql
CREATE TABLE trade_notes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trade_id INT NOT NULL COMMENT '交易ID',
    note_id INT NOT NULL COMMENT '笔记ID',
    note_stage ENUM('plan', 'entry', 'holding', 'exit', 'review') NOT NULL COMMENT '笔记阶段',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (trade_id) REFERENCES trades(id) ON DELETE CASCADE,
    FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE,
    INDEX idx_trade_id (trade_id),
    INDEX idx_note_stage (note_stage)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='交易笔记关联表';
```

### 2.3 交易截图表 (trade_screenshots)

```sql
CREATE TABLE trade_screenshots (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trade_id INT NOT NULL COMMENT '交易ID',
    screenshot_type ENUM('kline', 'entry', 'exit', 'other') NOT NULL COMMENT '截图类型',
    screenshot_stage ENUM('plan', 'entry', 'holding', 'exit', 'review') NOT NULL COMMENT '截图阶段',
    file_path VARCHAR(500) NOT NULL COMMENT '文件路径',
    file_url VARCHAR(500) COMMENT '访问URL',
    description TEXT COMMENT '截图描述',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (trade_id) REFERENCES trades(id) ON DELETE CASCADE,
    INDEX idx_trade_id (trade_id),
    INDEX idx_screenshot_type (screenshot_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='交易截图表';
```

### 2.4 交易提醒表 (trade_alerts)

```sql
CREATE TABLE trade_alerts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trade_id INT NOT NULL COMMENT '交易ID',
    
    -- 提醒类型
    alert_type ENUM('price', 'time', 'pnl', 'custom') NOT NULL COMMENT '提醒类型',
    
    -- 价格提醒
    trigger_price DECIMAL(10, 2) COMMENT '触发价格',
    price_direction ENUM('above', 'below') COMMENT '价格方向：向上/向下',
    
    -- 时间提醒
    trigger_time DATETIME COMMENT '触发时间',
    
    -- 盈亏提醒
    trigger_pnl_pct DECIMAL(5, 2) COMMENT '触发盈亏百分比',
    pnl_direction ENUM('profit', 'loss') COMMENT '盈亏方向',
    
    -- 提醒设置
    alert_title VARCHAR(200) NOT NULL COMMENT '提醒标题',
    alert_message TEXT COMMENT '提醒内容',
    is_repeating BOOLEAN DEFAULT FALSE COMMENT '是否重复提醒',
    repeat_interval INT COMMENT '重复间隔(分钟)',
    
    -- 状态
    status ENUM('active', 'triggered', 'cancelled') NOT NULL DEFAULT 'active',
    triggered_at DATETIME COMMENT '触发时间',
    
    -- 通知方式
    notify_browser BOOLEAN DEFAULT TRUE COMMENT '浏览器通知',
    notify_email BOOLEAN DEFAULT FALSE COMMENT '邮件通知',
    notify_sms BOOLEAN DEFAULT FALSE COMMENT '短信通知',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (trade_id) REFERENCES trades(id) ON DELETE CASCADE,
    INDEX idx_trade_id (trade_id),
    INDEX idx_status (status),
    INDEX idx_trigger_time (trigger_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='交易提醒表';
```

### 2.5 交易调整记录表 (trade_adjustments)

```sql
CREATE TABLE trade_adjustments (
    id INT PRIMARY KEY AUTO_INCREMENT,
    trade_id INT NOT NULL COMMENT '交易ID',
    adjustment_type ENUM('add_position', 'reduce_position', 'stop_loss', 'take_profit', 'other') NOT NULL,
    
    -- 调整内容
    price DECIMAL(10, 2) COMMENT '调整价格',
    quantity INT COMMENT '调整数量',
    new_stop_loss DECIMAL(10, 2) COMMENT '新止损价',
    new_take_profit DECIMAL(10, 2) COMMENT '新止盈价',
    
    -- 说明
    reason TEXT COMMENT '调整原因',
    notes TEXT COMMENT '调整笔记',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (trade_id) REFERENCES trades(id) ON DELETE CASCADE,
    INDEX idx_trade_id (trade_id),
    INDEX idx_adjustment_type (adjustment_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='交易调整记录表';
```

## 3. API 接口设计

### 3.1 交易计划相关

```python
# 创建交易计划
POST /api/v1/trades/plans
{
    "symbol": "AAPL",
    "plan_type": "long",
    "plan_entry_price": 180.50,
    "plan_entry_price_range_low": 179.00,
    "plan_entry_price_range_high": 182.00,
    "plan_quantity": 100,
    "plan_stop_loss": 175.00,
    "plan_take_profit": 190.00,
    "plan_notes": "突破月线阻力位",
    "plan_strategy": "技术面突破+基本面支撑"
}

# 获取等待执行的交易计划
GET /api/v1/trades/plans/pending

# 更新交易计划
PUT /api/v1/trades/plans/{trade_id}

# 取消交易计划
POST /api/v1/trades/plans/{trade_id}/cancel
```

### 3.2 交易执行相关

```python
# 开仓（执行计划）
POST /api/v1/trades/{trade_id}/open
{
    "entry_price": 180.80,
    "entry_quantity": 100,
    "entry_time": "2024-01-15T10:30:00",
    "entry_notes": "按计划入场"
}

# 加仓
POST /api/v1/trades/{trade_id}/add-position
{
    "price": 182.50,
    "quantity": 50,
    "notes": "突破关键位置加仓"
}

# 减仓
POST /api/v1/trades/{trade_id}/reduce-position
{
    "price": 185.00,
    "quantity": 50,
    "notes": "部分止盈"
}

# 平仓
POST /api/v1/trades/{trade_id}/close
{
    "exit_price": 188.50,
    "exit_quantity": 100,
    "exit_time": "2024-01-20T15:30:00",
    "exit_notes": "达到止盈目标"
}

# 更新止损止盈
PUT /api/v1/trades/{trade_id}/stop-loss-take-profit
{
    "stop_loss_price": 183.00,
    "take_profit_price": 195.00
}
```

### 3.3 持仓查询相关

```python
# 获取正在交易的持仓
GET /api/v1/trades/active
# 返回：持仓列表，包含实时盈亏

# 获取历史交易记录
GET /api/v1/trades/history
# 查询参数：
# - page, page_size: 分页
# - symbol: 股票代码
# - start_date, end_date: 日期范围
# - status: 交易状态
# - min_pnl, max_pnl: 盈亏范围
# - strategy_id: 策略筛选

# 获取单个交易详情
GET /api/v1/trades/{trade_id}
# 返回：完整交易信息，包括所有笔记、截图、调整记录
```

### 3.4 交易笔记相关

```python
# 为交易添加笔记
POST /api/v1/trades/{trade_id}/notes
{
    "note_id": 123,  # 现有笔记ID
    "note_stage": "entry"
}

# 创建并关联笔记
POST /api/v1/trades/{trade_id}/notes/create
{
    "note_stage": "holding",
    "title": "持仓观察",
    "content": "...",
    "tags": [...]
}

# 获取交易的所有笔记
GET /api/v1/trades/{trade_id}/notes
```

### 3.5 交易截图相关

```python
# 上传交易截图
POST /api/v1/trades/{trade_id}/screenshots
# Content-Type: multipart/form-data
{
    "file": <binary>,
    "screenshot_type": "kline",
    "screenshot_stage": "plan",
    "description": "计划阶段K线图"
}

# 获取交易截图
GET /api/v1/trades/{trade_id}/screenshots

# 删除截图
DELETE /api/v1/trades/screenshots/{screenshot_id}
```

### 3.6 交易提醒相关

```python
# 创建提醒
POST /api/v1/trades/{trade_id}/alerts
{
    "alert_type": "price",
    "trigger_price": 185.00,
    "price_direction": "above",
    "alert_title": "价格突破提醒",
    "alert_message": "AAPL 突破 185 美元",
    "notify_browser": true
}

# 获取交易提醒
GET /api/v1/trades/{trade_id}/alerts

# 取消提醒
DELETE /api/v1/trades/alerts/{alert_id}

# 获取所有活跃提醒（用于前端轮询）
GET /api/v1/trades/alerts/active
```

### 3.7 统计分析相关

```python
# 交易统计
GET /api/v1/trades/statistics
# 返回：
# - 总交易次数
# - 盈利次数、亏损次数
# - 胜率
# - 总盈亏、平均盈亏
# - 最大单笔盈利/亏损
# - 最大连续盈利/亏损

# 按股票统计
GET /api/v1/trades/statistics/by-symbol

# 按策略统计
GET /api/v1/trades/statistics/by-strategy
```

## 4. 前端界面设计

### 4.1 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  我的交易                                                │
├─────────────────────────────────────────────────────────┤
│  [正在交易] [等待执行] [历史记录] [统计分析]           │
├─────────────────────────────────────────────────────────┤
│  筛选：[股票代码] [日期范围] [策略] [盈亏范围]         │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐    │
│  │ AAPL - Apple Inc.                    [查看详情] │    │
│  │ 入场: $180.50 → 当前: $185.20 (+2.61%)         │    │
│  │ 数量: 100股 | 浮动盈亏: +$470.00               │    │
│  │ 止损: $175.00 | 止盈: $190.00                  │    │
│  │ [添加笔记] [上传截图] [设置提醒] [调整仓位]   │    │
│  └─────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────┐    │
│  │ TSLA - Tesla Inc.                    [查看详情] │    │
│  │ 入场: $220.00 → 当前: $215.50 (-2.05%)         │    │
│  │ ...                                             │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘
```

### 4.2 交易详情页面

```
┌─────────────────────────────────────────────────────────┐
│  ← 返回    AAPL - Apple Inc.                            │
├─────────────────────────────────────────────────────────┤
│  [计划] [入场] [持仓] [调整] [平仓] [复盘]             │
├─────────────────────────────────────────────────────────┤
│  持仓概览                                                │
│  ┌────────────┬────────────┬────────────┬────────────┐  │
│  │ 入场价格   │ 当前价格   │ 浮动盈亏   │ 持仓天数   │  │
│  │ $180.50    │ $185.20    │ +$470      │ 5天        │  │
│  └────────────┴────────────┴────────────┴────────────┘  │
├─────────────────────────────────────────────────────────┤
│  K线图 [上传截图]                                        │
│  ┌─────────────────────────────────────────────────┐    │
│  │                                                  │    │
│  │          [K线图显示区域]                         │    │
│  │                                                  │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  交易笔记 [新建笔记]                                     │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 📝 2024-01-15 10:30 - 入场笔记                  │    │
│  │    按计划价格入场，突破月线阻力位...             │    │
│  └─────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────┐    │
│  │ 📝 2024-01-17 14:00 - 持仓观察                  │    │
│  │    股价持续向上，关注MACD金叉信号...            │    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  活跃提醒 [新建提醒]                                     │
│  🔔 价格突破 $190 提醒                                   │
│  🔔 止损价格 $175 监控                                   │
└─────────────────────────────────────────────────────────┘
```

### 4.3 组件清单

1. **TradeList.tsx** - 交易列表组件
2. **TradeCard.tsx** - 交易卡片组件
3. **TradeDetail.tsx** - 交易详情组件
4. **TradePlanForm.tsx** - 交易计划表单
5. **TradePositionPanel.tsx** - 持仓面板
6. **TradeAdjustmentForm.tsx** - 仓位调整表单
7. **TradeAlertForm.tsx** - 提醒设置表单
8. **TradeScreenshotUploader.tsx** - 截图上传组件
9. **TradeTimeline.tsx** - 交易时间线
10. **TradeStatistics.tsx** - 交易统计面板

## 5. 关键功能实现

### 5.1 实时盈亏计算

```python
# 后台任务：定时更新持仓盈亏
@scheduler.task('interval', minutes=1)
async def update_active_trades_pnl():
    active_trades = await get_active_trades()
    for trade in active_trades:
        # 获取最新价格
        current_price = await market_data.get_latest_price(trade.symbol)
        
        # 计算盈亏
        if trade.plan_type == 'long':
            unrealized_pnl = (current_price - trade.entry_price) * trade.current_quantity
        else:  # short
            unrealized_pnl = (trade.entry_price - current_price) * trade.current_quantity
        
        unrealized_pnl_pct = (unrealized_pnl / (trade.entry_price * trade.current_quantity)) * 100
        
        # 更新数据库
        await update_trade(trade.id, {
            'current_price': current_price,
            'unrealized_pnl': unrealized_pnl,
            'unrealized_pnl_pct': unrealized_pnl_pct
        })
        
        # 检查提醒触发
        await check_trade_alerts(trade)
```

### 5.2 提醒触发检查

```python
async def check_trade_alerts(trade):
    alerts = await get_active_alerts(trade.id)
    
    for alert in alerts:
        triggered = False
        
        if alert.alert_type == 'price':
            if alert.price_direction == 'above' and trade.current_price >= alert.trigger_price:
                triggered = True
            elif alert.price_direction == 'below' and trade.current_price <= alert.trigger_price:
                triggered = True
        
        elif alert.alert_type == 'pnl':
            if alert.pnl_direction == 'profit' and trade.unrealized_pnl_pct >= alert.trigger_pnl_pct:
                triggered = True
            elif alert.pnl_direction == 'loss' and trade.unrealized_pnl_pct <= -alert.trigger_pnl_pct:
                triggered = True
        
        elif alert.alert_type == 'time':
            if datetime.now() >= alert.trigger_time:
                triggered = True
        
        if triggered:
            await trigger_alert(alert, trade)
```

### 5.3 截图存储

```python
# 文件存储结构
/uploads/
  /trades/
    /{trade_id}/
      /screenshots/
        /plan/
        /entry/
        /holding/
        /exit/
        /review/

# 文件命名规则
{timestamp}_{screenshot_type}_{random}.jpg
```

## 6. 实现优先级

### Phase 1 - 核心功能（第1周）
- [ ] 数据库表创建
- [ ] 基础API接口（CRUD）
- [ ] 交易列表页面（正在交易/等待执行/历史记录）
- [ ] 交易计划创建表单
- [ ] 开仓/平仓功能

### Phase 2 - 增强功能（第2周）
- [ ] 交易详情页面
- [ ] 笔记关联功能
- [ ] 截图上传功能
- [ ] 仓位调整功能
- [ ] 实时盈亏更新

### Phase 3 - 高级功能（第3周）
- [ ] 提醒系统
- [ ] 交易时间线
- [ ] 统计分析面板
- [ ] 复盘功能
- [ ] 批量操作

## 7. 技术要点

### 7.1 实时数据更新
- 使用 WebSocket 推送价格更新
- 前端使用 SWR 或 React Query 自动刷新
- 乐观更新提升用户体验

### 7.2 文件上传
- 支持拖拽上传
- 图片压缩和预览
- CDN 加速访问

### 7.3 提醒通知
- 浏览器 Notification API
- 可选邮件/短信通知
- 提醒历史记录

### 7.4 性能优化
- 历史记录分页加载
- 虚拟滚动（大量数据）
- 图片懒加载

## 8. 与其他模块的集成

### 8.1 与交易笔记的关系
- 交易可以关联多个笔记
- 笔记可以属于交易的不同阶段
- 从交易详情快速创建笔记

### 8.2 与策略系统的关系
- 交易可以标记使用的策略
- 按策略统计交易效果
- 验证策略有效性

### 8.3 与数据源的关系
- 实时获取股票价格
- 历史K线数据展示
- 基本面数据参考

## 9. 未来扩展

- [ ] 交易日历视图
- [ ] 交易对比分析
- [ ] AI 交易建议
- [ ] 交易分享功能
- [ ] 交易模板
- [ ] 模拟交易

---

**文档版本**: v1.0  
**创建日期**: 2025-10-18  
**最后更新**: 2025-10-18

