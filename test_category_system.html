<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分类系统测试 - 智行交易</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 24px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .success {
            color: #10b981;
            font-weight: bold;
        }

        .error {
            color: #ef4444;
            font-weight: bold;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .quick-links {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .quick-links a {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #f3f4f6;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .quick-links a:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 股票分类系统测试面板</h1>
            <p class="subtitle">
                测试多级分类树和热力图功能
                <span id="apiStatus" class="status">检测中...</span>
            </p>
        </div>

        <div class="grid">
            <!-- 测试1: 获取分类树 -->
            <div class="card">
                <h2><span class="icon">🌳</span>获取分类树</h2>
                <button onclick="testGetCategories()">获取树形结构</button>
                <button onclick="testGetCategoriesFlat()">获取扁平列表</button>
                <div id="result1" class="result"></div>
            </div>

            <!-- 测试2: 创建分类 -->
            <div class="card">
                <h2><span class="icon">➕</span>创建分类</h2>
                <button onclick="testCreateCategory()">创建根分类</button>
                <button onclick="testCreateSubCategory()">创建子分类</button>
                <div id="result2" class="result"></div>
            </div>

            <!-- 测试3: 获取热力图 -->
            <div class="card">
                <h2><span class="icon">🔥</span>热力图数据</h2>
                <button onclick="testGetHeatmap()">获取热力图</button>
                <button onclick="testRefreshHeatmap()">刷新数据</button>
                <div id="result3" class="result"></div>
            </div>

            <!-- 测试4: 分类操作 -->
            <div class="card">
                <h2><span class="icon">⚙️</span>分类操作</h2>
                <button onclick="testUpdateCategory()">更新分类</button>
                <button onclick="testDeleteCategory()">删除分类</button>
                <div id="result4" class="result"></div>
            </div>

            <!-- 测试5: 股票关联 -->
            <div class="card">
                <h2><span class="icon">📊</span>股票关联</h2>
                <button onclick="testAddStock()">添加股票</button>
                <button onclick="testGetCategoryStocks()">查看股票列表</button>
                <button onclick="testRemoveStock()">移除股票</button>
                <div id="result5" class="result"></div>
            </div>

            <!-- 测试6: 批量操作 -->
            <div class="card">
                <h2><span class="icon">📦</span>批量操作</h2>
                <button onclick="testBatchImport()">批量导入</button>
                <button onclick="testExport()">导出数据</button>
                <div id="result6" class="result"></div>
            </div>
        </div>

        <!-- 快速链接 -->
        <div class="quick-links">
            <h2 style="margin-bottom: 15px;">🔗 快速链接</h2>
            <a href="http://localhost:3000/categories" target="_blank">📱 前端分类页面</a>
            <a href="http://localhost:8000/docs" target="_blank">📚 API文档</a>
            <a href="http://localhost:8000/api/v1/categories/" target="_blank">🌐 API测试</a>
            <a href="./docs/CATEGORY_SYSTEM_GUIDE.md" target="_blank">📖 使用指南</a>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let testCategoryId = null;

        // 检查API状态
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE}/categories/`);
                const statusEl = document.getElementById('apiStatus');
                if (response.ok) {
                    statusEl.textContent = '在线';
                    statusEl.className = 'status online';
                } else {
                    statusEl.textContent = '离线';
                    statusEl.className = 'status offline';
                }
            } catch (error) {
                const statusEl = document.getElementById('apiStatus');
                statusEl.textContent = '离线';
                statusEl.className = 'status offline';
            }
        }

        // 辅助函数
        function showResult(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const status = isError ? '❌ 失败' : '✅ 成功';
            el.innerHTML = `[${timestamp}] ${status}\n\n${JSON.stringify(data, null, 2)}`;
            el.scrollTop = el.scrollHeight;
        }

        // 测试1: 获取分类树
        async function testGetCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories/`);
                const data = await response.json();
                showResult('result1', data);
                if (data.data && data.data.length > 0) {
                    testCategoryId = data.data[0].category_id;
                }
            } catch (error) {
                showResult('result1', { error: error.message }, true);
            }
        }

        async function testGetCategoriesFlat() {
            try {
                const response = await fetch(`${API_BASE}/categories/?flat=true`);
                const data = await response.json();
                showResult('result1', data);
            } catch (error) {
                showResult('result1', { error: error.message }, true);
            }
        }

        // 测试2: 创建分类
        async function testCreateCategory() {
            try {
                const response = await fetch(`${API_BASE}/categories/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: '测试分类_' + Date.now(),
                        icon: '🧪',
                        color: '#3B82F6',
                        description: '这是一个测试分类',
                        sort_order: 0
                    })
                });
                const data = await response.json();
                showResult('result2', data);
                if (data.success) {
                    testCategoryId = data.data.category_id;
                }
            } catch (error) {
                showResult('result2', { error: error.message }, true);
            }
        }

        async function testCreateSubCategory() {
            if (!testCategoryId) {
                showResult('result2', { error: '请先创建根分类' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/categories/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: '子分类_' + Date.now(),
                        parent_id: testCategoryId,
                        icon: '📁',
                        color: '#10B981'
                    })
                });
                const data = await response.json();
                showResult('result2', data);
            } catch (error) {
                showResult('result2', { error: error.message }, true);
            }
        }

        // 测试3: 热力图
        async function testGetHeatmap() {
            try {
                const response = await fetch(`${API_BASE}/categories/heatmap/data`);
                const data = await response.json();
                showResult('result3', data);
            } catch (error) {
                showResult('result3', { error: error.message }, true);
            }
        }

        async function testRefreshHeatmap() {
            await testGetHeatmap();
        }

        // 测试4: 分类操作
        async function testUpdateCategory() {
            if (!testCategoryId) {
                showResult('result4', { error: '请先创建一个分类' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: '更新后的分类_' + Date.now(),
                        description: '这是更新后的描述'
                    })
                });
                const data = await response.json();
                showResult('result4', data);
            } catch (error) {
                showResult('result4', { error: error.message }, true);
            }
        }

        async function testDeleteCategory() {
            if (!testCategoryId) {
                showResult('result4', { error: '请先创建一个分类' }, true);
                return;
            }
            if (!confirm('确定要删除测试分类吗？')) return;
            
            try {
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}?force=true`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult('result4', data);
                testCategoryId = null;
            } catch (error) {
                showResult('result4', { error: error.message }, true);
            }
        }

        // 测试5: 股票关联
        async function testAddStock() {
            if (!testCategoryId) {
                showResult('result5', { error: '请先创建一个分类' }, true);
                return;
            }
            try {
                // 先获取一个股票
                const stocksResponse = await fetch(`${API_BASE}/stocks/?page=1&page_size=1`);
                const stocksData = await stocksResponse.json();
                
                if (!stocksData.success || stocksData.data.stocks.length === 0) {
                    showResult('result5', { error: '没有可用的股票' }, true);
                    return;
                }
                
                const stockCode = stocksData.data.stocks[0].symbol;
                
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_id: testCategoryId,
                        stock_code: stockCode,
                        weight: 1.0,
                        is_primary: true
                    })
                });
                const data = await response.json();
                showResult('result5', { stock_code: stockCode, ...data });
            } catch (error) {
                showResult('result5', { error: error.message }, true);
            }
        }

        async function testGetCategoryStocks() {
            if (!testCategoryId) {
                showResult('result5', { error: '请先创建一个分类' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks`);
                const data = await response.json();
                showResult('result5', data);
            } catch (error) {
                showResult('result5', { error: error.message }, true);
            }
        }

        async function testRemoveStock() {
            if (!testCategoryId) {
                showResult('result5', { error: '请先创建一个分类并添加股票' }, true);
                return;
            }
            try {
                // 先获取分类的股票列表
                const stocksResponse = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks`);
                const stocksData = await stocksResponse.json();
                
                if (!stocksData.success || stocksData.data.stocks.length === 0) {
                    showResult('result5', { error: '该分类下没有股票' }, true);
                    return;
                }
                
                const stockCode = stocksData.data.stocks[0].symbol;
                
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks/${stockCode}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult('result5', { stock_code: stockCode, ...data });
            } catch (error) {
                showResult('result5', { error: error.message }, true);
            }
        }

        // 测试6: 批量操作
        async function testBatchImport() {
            const categories = [
                {
                    name: '批量导入测试',
                    icon: '📦',
                    color: '#3B82F6',
                    children: [
                        { name: '子分类1', icon: '📁' },
                        { name: '子分类2', icon: '📂' }
                    ]
                }
            ];
            
            try {
                const response = await fetch(`${API_BASE}/categories/batch-import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories })
                });
                const data = await response.json();
                showResult('result6', data);
            } catch (error) {
                showResult('result6', { error: error.message }, true);
            }
        }

        async function testExport() {
            try {
                const response = await fetch(`${API_BASE}/categories/?flat=true`);
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `categories_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showResult('result6', { message: '导出成功', count: data.data.length });
                } else {
                    showResult('result6', data, true);
                }
            } catch (error) {
                showResult('result6', { error: error.message }, true);
            }
        }

        // 页面加载时检查API状态
        checkApiStatus();
        setInterval(checkApiStatus, 30000); // 每30秒检查一次
    </script>
</body>
</html>

