<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»ç³»ç»Ÿæµ‹è¯• - æ™ºè¡Œäº¤æ˜“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 24px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .success {
            color: #10b981;
            font-weight: bold;
        }

        .error {
            color: #ef4444;
            font-weight: bold;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .quick-links {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .quick-links a {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #f3f4f6;
            color: #667eea;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .quick-links a:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ è‚¡ç¥¨åˆ†ç±»ç³»ç»Ÿæµ‹è¯•é¢æ¿</h1>
            <p class="subtitle">
                æµ‹è¯•å¤šçº§åˆ†ç±»æ ‘å’Œçƒ­åŠ›å›¾åŠŸèƒ½
                <span id="apiStatus" class="status">æ£€æµ‹ä¸­...</span>
            </p>
        </div>

        <div class="grid">
            <!-- æµ‹è¯•1: è·å–åˆ†ç±»æ ‘ -->
            <div class="card">
                <h2><span class="icon">ğŸŒ³</span>è·å–åˆ†ç±»æ ‘</h2>
                <button onclick="testGetCategories()">è·å–æ ‘å½¢ç»“æ„</button>
                <button onclick="testGetCategoriesFlat()">è·å–æ‰å¹³åˆ—è¡¨</button>
                <div id="result1" class="result"></div>
            </div>

            <!-- æµ‹è¯•2: åˆ›å»ºåˆ†ç±» -->
            <div class="card">
                <h2><span class="icon">â•</span>åˆ›å»ºåˆ†ç±»</h2>
                <button onclick="testCreateCategory()">åˆ›å»ºæ ¹åˆ†ç±»</button>
                <button onclick="testCreateSubCategory()">åˆ›å»ºå­åˆ†ç±»</button>
                <div id="result2" class="result"></div>
            </div>

            <!-- æµ‹è¯•3: è·å–çƒ­åŠ›å›¾ -->
            <div class="card">
                <h2><span class="icon">ğŸ”¥</span>çƒ­åŠ›å›¾æ•°æ®</h2>
                <button onclick="testGetHeatmap()">è·å–çƒ­åŠ›å›¾</button>
                <button onclick="testRefreshHeatmap()">åˆ·æ–°æ•°æ®</button>
                <div id="result3" class="result"></div>
            </div>

            <!-- æµ‹è¯•4: åˆ†ç±»æ“ä½œ -->
            <div class="card">
                <h2><span class="icon">âš™ï¸</span>åˆ†ç±»æ“ä½œ</h2>
                <button onclick="testUpdateCategory()">æ›´æ–°åˆ†ç±»</button>
                <button onclick="testDeleteCategory()">åˆ é™¤åˆ†ç±»</button>
                <div id="result4" class="result"></div>
            </div>

            <!-- æµ‹è¯•5: è‚¡ç¥¨å…³è” -->
            <div class="card">
                <h2><span class="icon">ğŸ“Š</span>è‚¡ç¥¨å…³è”</h2>
                <button onclick="testAddStock()">æ·»åŠ è‚¡ç¥¨</button>
                <button onclick="testGetCategoryStocks()">æŸ¥çœ‹è‚¡ç¥¨åˆ—è¡¨</button>
                <button onclick="testRemoveStock()">ç§»é™¤è‚¡ç¥¨</button>
                <div id="result5" class="result"></div>
            </div>

            <!-- æµ‹è¯•6: æ‰¹é‡æ“ä½œ -->
            <div class="card">
                <h2><span class="icon">ğŸ“¦</span>æ‰¹é‡æ“ä½œ</h2>
                <button onclick="testBatchImport()">æ‰¹é‡å¯¼å…¥</button>
                <button onclick="testExport()">å¯¼å‡ºæ•°æ®</button>
                <div id="result6" class="result"></div>
            </div>
        </div>

        <!-- å¿«é€Ÿé“¾æ¥ -->
        <div class="quick-links">
            <h2 style="margin-bottom: 15px;">ğŸ”— å¿«é€Ÿé“¾æ¥</h2>
            <a href="http://localhost:3000/categories" target="_blank">ğŸ“± å‰ç«¯åˆ†ç±»é¡µé¢</a>
            <a href="http://localhost:8000/docs" target="_blank">ğŸ“š APIæ–‡æ¡£</a>
            <a href="http://localhost:8000/api/v1/categories/" target="_blank">ğŸŒ APIæµ‹è¯•</a>
            <a href="./docs/CATEGORY_SYSTEM_GUIDE.md" target="_blank">ğŸ“– ä½¿ç”¨æŒ‡å—</a>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let testCategoryId = null;

        // æ£€æŸ¥APIçŠ¶æ€
        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE}/categories/`);
                const statusEl = document.getElementById('apiStatus');
                if (response.ok) {
                    statusEl.textContent = 'åœ¨çº¿';
                    statusEl.className = 'status online';
                } else {
                    statusEl.textContent = 'ç¦»çº¿';
                    statusEl.className = 'status offline';
                }
            } catch (error) {
                const statusEl = document.getElementById('apiStatus');
                statusEl.textContent = 'ç¦»çº¿';
                statusEl.className = 'status offline';
            }
        }

        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const status = isError ? 'âŒ å¤±è´¥' : 'âœ… æˆåŠŸ';
            el.innerHTML = `[${timestamp}] ${status}\n\n${JSON.stringify(data, null, 2)}`;
            el.scrollTop = el.scrollHeight;
        }

        // æµ‹è¯•1: è·å–åˆ†ç±»æ ‘
        async function testGetCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories/`);
                const data = await response.json();
                showResult('result1', data);
                if (data.data && data.data.length > 0) {
                    testCategoryId = data.data[0].category_id;
                }
            } catch (error) {
                showResult('result1', { error: error.message }, true);
            }
        }

        async function testGetCategoriesFlat() {
            try {
                const response = await fetch(`${API_BASE}/categories/?flat=true`);
                const data = await response.json();
                showResult('result1', data);
            } catch (error) {
                showResult('result1', { error: error.message }, true);
            }
        }

        // æµ‹è¯•2: åˆ›å»ºåˆ†ç±»
        async function testCreateCategory() {
            try {
                const response = await fetch(`${API_BASE}/categories/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'æµ‹è¯•åˆ†ç±»_' + Date.now(),
                        icon: 'ğŸ§ª',
                        color: '#3B82F6',
                        description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•åˆ†ç±»',
                        sort_order: 0
                    })
                });
                const data = await response.json();
                showResult('result2', data);
                if (data.success) {
                    testCategoryId = data.data.category_id;
                }
            } catch (error) {
                showResult('result2', { error: error.message }, true);
            }
        }

        async function testCreateSubCategory() {
            if (!testCategoryId) {
                showResult('result2', { error: 'è¯·å…ˆåˆ›å»ºæ ¹åˆ†ç±»' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/categories/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'å­åˆ†ç±»_' + Date.now(),
                        parent_id: testCategoryId,
                        icon: 'ğŸ“',
                        color: '#10B981'
                    })
                });
                const data = await response.json();
                showResult('result2', data);
            } catch (error) {
                showResult('result2', { error: error.message }, true);
            }
        }

        // æµ‹è¯•3: çƒ­åŠ›å›¾
        async function testGetHeatmap() {
            try {
                const response = await fetch(`${API_BASE}/categories/heatmap/data`);
                const data = await response.json();
                showResult('result3', data);
            } catch (error) {
                showResult('result3', { error: error.message }, true);
            }
        }

        async function testRefreshHeatmap() {
            await testGetHeatmap();
        }

        // æµ‹è¯•4: åˆ†ç±»æ“ä½œ
        async function testUpdateCategory() {
            if (!testCategoryId) {
                showResult('result4', { error: 'è¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç±»' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'æ›´æ–°åçš„åˆ†ç±»_' + Date.now(),
                        description: 'è¿™æ˜¯æ›´æ–°åçš„æè¿°'
                    })
                });
                const data = await response.json();
                showResult('result4', data);
            } catch (error) {
                showResult('result4', { error: error.message }, true);
            }
        }

        async function testDeleteCategory() {
            if (!testCategoryId) {
                showResult('result4', { error: 'è¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç±»' }, true);
                return;
            }
            if (!confirm('ç¡®å®šè¦åˆ é™¤æµ‹è¯•åˆ†ç±»å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}?force=true`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult('result4', data);
                testCategoryId = null;
            } catch (error) {
                showResult('result4', { error: error.message }, true);
            }
        }

        // æµ‹è¯•5: è‚¡ç¥¨å…³è”
        async function testAddStock() {
            if (!testCategoryId) {
                showResult('result5', { error: 'è¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç±»' }, true);
                return;
            }
            try {
                // å…ˆè·å–ä¸€ä¸ªè‚¡ç¥¨
                const stocksResponse = await fetch(`${API_BASE}/stocks/?page=1&page_size=1`);
                const stocksData = await stocksResponse.json();
                
                if (!stocksData.success || stocksData.data.stocks.length === 0) {
                    showResult('result5', { error: 'æ²¡æœ‰å¯ç”¨çš„è‚¡ç¥¨' }, true);
                    return;
                }
                
                const stockCode = stocksData.data.stocks[0].symbol;
                
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_id: testCategoryId,
                        stock_code: stockCode,
                        weight: 1.0,
                        is_primary: true
                    })
                });
                const data = await response.json();
                showResult('result5', { stock_code: stockCode, ...data });
            } catch (error) {
                showResult('result5', { error: error.message }, true);
            }
        }

        async function testGetCategoryStocks() {
            if (!testCategoryId) {
                showResult('result5', { error: 'è¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç±»' }, true);
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks`);
                const data = await response.json();
                showResult('result5', data);
            } catch (error) {
                showResult('result5', { error: error.message }, true);
            }
        }

        async function testRemoveStock() {
            if (!testCategoryId) {
                showResult('result5', { error: 'è¯·å…ˆåˆ›å»ºä¸€ä¸ªåˆ†ç±»å¹¶æ·»åŠ è‚¡ç¥¨' }, true);
                return;
            }
            try {
                // å…ˆè·å–åˆ†ç±»çš„è‚¡ç¥¨åˆ—è¡¨
                const stocksResponse = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks`);
                const stocksData = await stocksResponse.json();
                
                if (!stocksData.success || stocksData.data.stocks.length === 0) {
                    showResult('result5', { error: 'è¯¥åˆ†ç±»ä¸‹æ²¡æœ‰è‚¡ç¥¨' }, true);
                    return;
                }
                
                const stockCode = stocksData.data.stocks[0].symbol;
                
                const response = await fetch(`${API_BASE}/categories/${testCategoryId}/stocks/${stockCode}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                showResult('result5', { stock_code: stockCode, ...data });
            } catch (error) {
                showResult('result5', { error: error.message }, true);
            }
        }

        // æµ‹è¯•6: æ‰¹é‡æ“ä½œ
        async function testBatchImport() {
            const categories = [
                {
                    name: 'æ‰¹é‡å¯¼å…¥æµ‹è¯•',
                    icon: 'ğŸ“¦',
                    color: '#3B82F6',
                    children: [
                        { name: 'å­åˆ†ç±»1', icon: 'ğŸ“' },
                        { name: 'å­åˆ†ç±»2', icon: 'ğŸ“‚' }
                    ]
                }
            ];
            
            try {
                const response = await fetch(`${API_BASE}/categories/batch-import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories })
                });
                const data = await response.json();
                showResult('result6', data);
            } catch (error) {
                showResult('result6', { error: error.message }, true);
            }
        }

        async function testExport() {
            try {
                const response = await fetch(`${API_BASE}/categories/?flat=true`);
                const data = await response.json();
                
                if (data.success) {
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `categories_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showResult('result6', { message: 'å¯¼å‡ºæˆåŠŸ', count: data.data.length });
                } else {
                    showResult('result6', data, true);
                }
            } catch (error) {
                showResult('result6', { error: error.message }, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥APIçŠ¶æ€
        checkApiStatus();
        setInterval(checkApiStatus, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>

