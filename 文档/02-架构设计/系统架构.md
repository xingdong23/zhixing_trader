# 智行交易系统 - 整体架构设计

## 架构概览

智行交易系统采用**模块化微服务架构**，每个模块独立开发、独立部署、独立扩展。

## 整体架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                          前端层 (Frontend)                          │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           zhixing_fronted (Next.js + React)              │   │
│  │                    端口: 3000                             │   │
│  │  - 统一的Web界面                                           │   │
│  │  - 数据可视化                                              │   │
│  │  - 用户交互                                                │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬───────────────────────────────────────────┘
                         │ HTTP REST API / WebSocket
                         │
┌────────────────────────┴───────────────────────────────────────────┐
│                       后端服务层 (Backend Services)                 │
│                                                                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ zhixing_backend │  │ bitcoin_trader  │  │sentiment_monitor│  │
│  │   (股票交易)     │  │  (加密货币)      │  │   (舆情监控)     │  │
│  │   端口: 8000    │  │   端口: 8001    │  │   端口: 8002    │  │
│  │                 │  │                 │  │                 │  │
│  │ • A股数据       │  │ • BTC/ETH      │  │ • Reddit监控    │  │
│  │ • 量化策略      │  │ • 多交易所      │  │ • Twitter监控   │  │
│  │ • 技术分析      │  │ • 高频交易      │  │ • 情绪分析      │  │
│  │ • 交易计划      │  │ • 策略回测      │  │ • 告警推送      │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │            │
└───────────┼────────────────────┼────────────────────┼────────────┘
            │                    │                    │
            │                    │                    │
┌───────────▼────────────────────▼────────────────────▼────────────┐
│                        数据存储层 (Data Layer)                     │
│                                                                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │
│  │   MySQL    │  │   MySQL    │  │   MySQL    │  │   Redis    │ │
│  │  (股票DB)   │  │  (加密DB)   │  │  (舆情DB)   │  │  (缓存)     │ │
│  │            │  │            │  │            │  │            │ │
│  │ • K线数据   │  │ • K线数据   │  │ • 舆情数据  │  │ • 实时数据  │ │
│  │ • 策略配置  │  │ • 订单记录  │  │ • 用户画像  │  │ • 会话     │ │
│  │ • 交易记录  │  │ • 持仓信息  │  │ • 情绪指标  │  │ • 队列     │ │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │
└────────────────────────────────────────────────────────────────────┘
            │                    │                    │
            │                    │                    │
┌───────────▼────────────────────▼────────────────────▼────────────┐
│                     外部服务层 (External Services)                  │
│                                                                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │
│  │yfinance    │  │  Binance   │  │  Reddit    │  │   OKX      │ │
│  │Alpha Vantage│ │  WebSocket │  │   API      │  │   API      │ │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │
│                                                                    │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │
│  │ Twitter/X  │  │   Bybit    │  │ Telegram   │  │   Email    │ │
│  │    API     │  │    API     │  │    Bot     │  │   SMTP     │ │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │
└────────────────────────────────────────────────────────────────────┘
```

## 模块详细设计

### 1. zhixing_backend (股票交易模块)

**职责**:
- A股市场数据采集和存储
- 技术指标计算
- 量化策略执行
- 交易计划管理

**技术栈**:
- FastAPI (Web框架)
- SQLAlchemy (ORM)
- pandas, numpy (数据分析)
- yfinance, Alpha Vantage (数据源)

**数据库**:
- MySQL: 持久化存储
- Redis: 实时数据缓存

**端口**: 8000

---

### 2. bitcoin_trader (加密货币交易模块)

**职责**:
- 加密货币实时行情
- 多交易所交易执行
- 策略回测
- 风险管理

**技术栈**:
- FastAPI (Web框架)
- CCXT (交易所API统一接口)
- python-binance (币安专用)
- backtrader (回测引擎)

**数据库**:
- MySQL: K线、订单、持仓数据
- Redis: WebSocket数据缓存

**端口**: 8001

---

### 3. sentiment_monitor (舆情监控模块) - 规划中

**职责**:
- 社交媒体数据采集
- 情绪分析
- 热点追踪
- 异常告警

**技术栈**:
- FastAPI
- PRAW (Reddit API)
- Tweepy (Twitter API)
- NLP库 (情绪分析)

**数据库**:
- MySQL: 舆情数据存储
- Redis: 实时统计

**端口**: 8002

---

### 4. zhixing_fronted (前端界面)

**职责**:
- 统一的用户界面
- 数据可视化
- 交易操作界面
- 策略配置管理

**技术栈**:
- Next.js 14 (React框架)
- TypeScript
- Tailwind CSS
- shadcn/ui (UI组件)
- Chart.js / ECharts (图表)

**端口**: 3000

---

## 模块通信机制

### HTTP REST API

各模块提供RESTful API，遵循统一规范：

```
# 统一的API响应格式
{
  "status": "success" | "error",
  "data": {...},
  "message": "...",
  "timestamp": "2025-10-17T00:00:00"
}
```

### WebSocket (实时通信)

用于实时数据推送：

```
前端 ←WebSocket→ 后端模块
    ├─ 实时K线推送
    ├─ 订单状态更新
    └─ 告警通知
```

### 消息队列 (可选)

模块间异步通信可使用RabbitMQ/Redis：

```
模块A → [消息队列] → 模块B
       ├─ 数据同步
       ├─ 事件通知
       └─ 异步任务
```

---

## 数据存储策略

### 数据库隔离

每个模块使用独立的数据库实例或Schema：

```
MySQL Server
├── zhixing_stock (股票数据库)
├── bitcoin_trader (加密货币数据库)
└── sentiment_monitor (舆情数据库)
```

**优点**:
- 数据隔离，安全性高
- 独立备份和恢复
- 性能互不影响

### 共享数据

如需共享数据，通过API调用而非直接访问数据库：

```
模块A需要模块B的数据
↓
模块A调用模块B的API
↓
模块B返回数据
```

---

## 部署架构

### 开发环境

```
本地开发机
├── zhixing_backend (localhost:8000)
├── bitcoin_trader (localhost:8001)
├── sentiment_monitor (localhost:8002)
├── zhixing_fronted (localhost:3000)
├── MySQL (localhost:3306)
└── Redis (localhost:6379)
```

### 生产环境

```
                    ┌─────────────┐
                    │   Nginx     │
                    │  (反向代理)  │
                    └──────┬──────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
    ┌───────▼──────┐ ┌────▼─────┐ ┌─────▼──────┐
    │   Backend    │ │  Bitcoin │ │ Sentiment  │
    │   Server 1   │ │  Server 2│ │  Server 3  │
    └───────┬──────┘ └────┬─────┘ └─────┬──────┘
            │              │              │
            └──────────────┼──────────────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
    ┌───────▼──────┐ ┌────▼─────┐ ┌─────▼──────┐
    │  MySQL主从   │ │  Redis   │ │  RabbitMQ  │
    │   集群       │ │  集群    │ │   集群     │
    └──────────────┘ └──────────┘ └────────────┘
```

### Docker部署

每个模块提供Dockerfile：

```bash
# 构建镜像
docker build -t zhixing-backend ./zhixing_backend
docker build -t bitcoin-trader ./bitcoin_trader
docker build -t sentiment-monitor ./sentiment_monitor

# 使用docker-compose编排
docker-compose up -d
```

---

## 扩展性设计

### 水平扩展

每个模块可独立扩展：

```
Nginx负载均衡
├── Backend实例1
├── Backend实例2
└── Backend实例3
```

### 新增模块

按照标准模板创建新模块：

```
new_module/
├── app/
│   ├── api/
│   ├── core/
│   └── main.py
├── requirements.txt
└── run.py
```

更新根目录配置，注册新模块。

---

## 安全性设计

### API认证

使用JWT Token认证：

```
前端 → 登录 → 获取Token → 携带Token访问API
```

### 数据加密

- API密钥加密存储
- 敏感数据传输使用HTTPS
- 数据库连接使用SSL

### 权限控制

- 基于角色的访问控制(RBAC)
- API级别的权限验证
- 操作日志审计

---

## 监控和运维

### 日志系统

统一的日志格式和收集：

```
各模块 → 日志文件 → 日志收集器 → 日志分析平台
                   (Filebeat)    (ELK Stack)
```

### 性能监控

- API响应时间
- 数据库查询性能
- 系统资源使用

### 告警机制

- 系统异常告警
- 业务异常告警
- 性能阈值告警

---

## 开发规范

### API规范

- RESTful设计
- 统一的错误码
- 版本化 (/api/v1/)

### 代码规范

- Python: PEP 8
- TypeScript: ESLint
- 代码审查流程

### 文档规范

- 每个模块包含README
- API文档自动生成(Swagger)
- 架构文档维护

---

## 总结

智行交易系统的模块化架构具有以下优势：

✅ **独立性**: 模块可独立开发、测试、部署  
✅ **灵活性**: 技术栈可按需选择  
✅ **可扩展**: 新增模块简单，水平扩展容易  
✅ **可维护**: 代码隔离，职责清晰  
✅ **高可用**: 模块故障互不影响  

这种架构适合长期演进和团队协作，能够支持未来更多功能模块的接入。

