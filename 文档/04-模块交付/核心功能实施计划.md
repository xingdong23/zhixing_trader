# 核心功能实施计划

> **制定时间**: 2025年10月18日  
> **预计完成**: 8-10周  
> **功能数量**: 8个核心模块

---

## 📋 功能列表与优先级

| 序号 | 功能模块 | 优先级 | 预计工期 | 技术难度 | 业务价值 |
|------|---------|--------|---------|---------|---------|
| 1 | 券商API自动同步 | P0 | 2周 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 2 | 交易执行记录 | P0 | 1周 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 3 | 复盘系统 | P1 | 1.5周 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| 4 | 策略管理增强 | P1 | 1周 | ⭐⭐ | ⭐⭐⭐⭐ |
| 5 | 检查清单系统 | P1 | 1周 | ⭐⭐ | ⭐⭐⭐⭐ |
| 6 | 心理分析 | P2 | 1.5周 | ⭐⭐⭐ | ⭐⭐⭐ |
| 7 | 错误分析 | P2 | 1周 | ⭐⭐ | ⭐⭐⭐ |
| 8 | 数据透视表 | P1 | 2周 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

**总工期**: 约 11 周 (并行开发可压缩至 8-10 周)

---

## 1️⃣ 券商API自动同步

### 功能概述
自动从券商账户同步交易数据,无需手动操作,实时更新交易记录。

### 支持券商
- **盈透证券 (IBKR)** - Interactive Brokers
- **长桥证券 (Longbridge/LongPort)**

### 技术方案

#### 1.1 盈透证券 (IBKR) 集成

**方案选择**:
- **官方API**: IB Gateway + TWS API (Python版本)
- **第三选择**: ib_insync 库(更简单易用)

**实施步骤**:

```python
# backend/app/services/ibkr_sync.py
from ib_insync import IB, util
import asyncio

class IBKRSyncService:
    def __init__(self, host='127.0.0.1', port=7497, client_id=1):
        self.ib = IB()
        self.host = host
        self.port = port
        self.client_id = client_id
    
    async def connect(self):
        """连接到IB Gateway"""
        await self.ib.connectAsync(self.host, self.port, self.client_id)
    
    async def get_executions(self, days_back=7):
        """获取最近的交易执行记录"""
        executions = await self.ib.reqExecutionsAsync()
        return self._parse_executions(executions)
    
    async def get_positions(self):
        """获取当前持仓"""
        positions = self.ib.positions()
        return self._parse_positions(positions)
    
    async def get_account_summary(self):
        """获取账户摘要"""
        summary = self.ib.accountSummary()
        return self._parse_account_summary(summary)
    
    def _parse_executions(self, executions):
        """解析交易记录"""
        trades = []
        for exec_detail in executions:
            trade = {
                'symbol': exec_detail.contract.symbol,
                'side': 'buy' if exec_detail.execution.side == 'BOT' else 'sell',
                'quantity': exec_detail.execution.shares,
                'price': exec_detail.execution.price,
                'time': exec_detail.execution.time,
                'commission': exec_detail.commissionReport.commission if exec_detail.commissionReport else 0,
                'order_id': exec_detail.execution.orderId,
                'exec_id': exec_detail.execution.execId,
            }
            trades.append(trade)
        return trades
```

**API端点**:
```python
# backend/app/api/v1/ibkr.py
from fastapi import APIRouter, Depends, HTTPException
from app.services.ibkr_sync import IBKRSyncService

router = APIRouter(prefix="/ibkr", tags=["IBKR"])

@router.post("/connect")
async def connect_ibkr(credentials: IBKRCredentials):
    """连接到IBKR账户"""
    service = IBKRSyncService()
    try:
        await service.connect()
        return {"status": "connected"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.get("/sync/executions")
async def sync_executions(days: int = 7):
    """同步交易执行记录"""
    service = IBKRSyncService()
    executions = await service.get_executions(days_back=days)
    # 保存到数据库
    return {"trades": executions, "count": len(executions)}

@router.get("/sync/positions")
async def sync_positions():
    """同步当前持仓"""
    service = IBKRSyncService()
    positions = await service.get_positions()
    return {"positions": positions}
```

#### 1.2 长桥证券 (Longbridge) 集成

**方案选择**:
- **官方SDK**: longbridge-python-sdk

**实施步骤**:

```python
# backend/app/services/longbridge_sync.py
from longbridge.openapi import TradeContext, Config

class LongbridgeSyncService:
    def __init__(self, app_key, app_secret, access_token):
        self.config = Config(
            app_key=app_key,
            app_secret=app_secret,
            access_token=access_token
        )
        self.ctx = TradeContext(self.config)
    
    async def get_today_orders(self):
        """获取今日订单"""
        orders = await self.ctx.today_orders()
        return self._parse_orders(orders)
    
    async def get_history_orders(self, start_date, end_date):
        """获取历史订单"""
        orders = await self.ctx.history_orders(
            start_at=start_date,
            end_at=end_date
        )
        return self._parse_orders(orders)
    
    async def get_history_executions(self, start_date, end_date):
        """获取历史成交"""
        executions = await self.ctx.history_executions(
            start_at=start_date,
            end_at=end_date
        )
        return self._parse_executions(executions)
    
    async def get_account_balance(self):
        """获取账户余额"""
        balance = await self.ctx.account_balance()
        return self._parse_balance(balance)
    
    def _parse_executions(self, executions):
        """解析成交记录"""
        trades = []
        for exec in executions:
            trade = {
                'symbol': exec.symbol,
                'side': 'buy' if exec.side == 'Buy' else 'sell',
                'quantity': exec.quantity,
                'price': exec.price,
                'time': exec.trade_done_at,
                'order_id': exec.order_id,
                'trade_id': exec.trade_id,
            }
            trades.append(trade)
        return trades
```

#### 1.3 前端界面

```tsx
// zhixing_fronted/app/settings/brokers/page.tsx
'use client';

import { useState } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

export default function BrokerSettingsPage() {
  const [ibkrConnected, setIbkrConnected] = useState(false);
  const [longbridgeConnected, setLongbridgeConnected] = useState(false);

  return (
    <div className="container mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold">券商连接设置</h1>

      {/* 盈透证券 */}
      <Card className="p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <img src="/logos/ibkr.png" alt="IBKR" className="w-12 h-12" />
            <div>
              <h2 className="text-xl font-semibold">盈透证券 (IBKR)</h2>
              <p className="text-sm text-gray-500">自动同步交易记录和持仓</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {ibkrConnected ? (
              <>
                <span className="text-green-600">● 已连接</span>
                <Button variant="outline" size="sm">断开</Button>
              </>
            ) : (
              <span className="text-gray-400">未连接</span>
            )}
          </div>
        </div>

        {!ibkrConnected && (
          <div className="space-y-4 border-t pt-4">
            <div>
              <label className="text-sm font-medium">IB Gateway 地址</label>
              <Input placeholder="127.0.0.1" defaultValue="127.0.0.1" />
            </div>
            <div>
              <label className="text-sm font-medium">端口</label>
              <Input placeholder="7497" defaultValue="7497" />
            </div>
            <div>
              <label className="text-sm font-medium">Client ID</label>
              <Input placeholder="1" defaultValue="1" />
            </div>
            <Button onClick={() => setIbkrConnected(true)}>
              连接 IBKR
            </Button>
          </div>
        )}

        {ibkrConnected && (
          <div className="space-y-2 border-t pt-4">
            <Button variant="outline" className="w-full">
              🔄 立即同步交易记录
            </Button>
            <Button variant="outline" className="w-full">
              📊 同步当前持仓
            </Button>
            <Button variant="outline" className="w-full">
              💰 同步账户余额
            </Button>
          </div>
        )}
      </Card>

      {/* 长桥证券 */}
      <Card className="p-6">
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <img src="/logos/longbridge.png" alt="Longbridge" className="w-12 h-12" />
            <div>
              <h2 className="text-xl font-semibold">长桥证券 (Longbridge)</h2>
              <p className="text-sm text-gray-500">自动同步交易记录和持仓</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            {longbridgeConnected ? (
              <>
                <span className="text-green-600">● 已连接</span>
                <Button variant="outline" size="sm">断开</Button>
              </>
            ) : (
              <span className="text-gray-400">未连接</span>
            )}
          </div>
        </div>

        {!longbridgeConnected && (
          <div className="space-y-4 border-t pt-4">
            <div>
              <label className="text-sm font-medium">App Key</label>
              <Input type="password" placeholder="输入 App Key" />
            </div>
            <div>
              <label className="text-sm font-medium">App Secret</label>
              <Input type="password" placeholder="输入 App Secret" />
            </div>
            <div>
              <label className="text-sm font-medium">Access Token</label>
              <Input type="password" placeholder="输入 Access Token" />
            </div>
            <Button onClick={() => setLongbridgeConnected(true)}>
              连接 Longbridge
            </Button>
          </div>
        )}
      </Card>

      {/* 自动同步设置 */}
      <Card className="p-6">
        <h3 className="text-lg font-semibold mb-4">自动同步设置</h3>
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <span>启用自动同步</span>
            <input type="checkbox" className="toggle" />
          </div>
          <div>
            <label className="text-sm font-medium">同步频率</label>
            <select className="w-full border rounded px-3 py-2">
              <option>每5分钟</option>
              <option>每15分钟</option>
              <option>每30分钟</option>
              <option>每小时</option>
            </select>
          </div>
          <div>
            <label className="text-sm font-medium">同步时间段</label>
            <div className="flex gap-2">
              <Input type="time" defaultValue="09:00" />
              <span>至</span>
              <Input type="time" defaultValue="16:00" />
            </div>
          </div>
        </div>
      </Card>
    </div>
  );
}
```

### 依赖安装

```bash
# Backend
pip install ib_insync
pip install longbridge

# 或使用 requirements.txt
echo "ib_insync>=0.9.86" >> requirements.txt
echo "longbridge>=1.0.0" >> requirements.txt
```

### 数据库表设计

```sql
-- 券商连接配置表
CREATE TABLE broker_connections (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    broker_name VARCHAR(50) NOT NULL, -- 'ibkr' or 'longbridge'
    status VARCHAR(20) DEFAULT 'disconnected', -- 'connected', 'disconnected', 'error'
    credentials JSON, -- 加密存储
    auto_sync_enabled BOOLEAN DEFAULT FALSE,
    sync_frequency_minutes INT DEFAULT 30,
    sync_start_time TIME DEFAULT '09:00:00',
    sync_end_time TIME DEFAULT '16:00:00',
    last_sync_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 同步历史记录表
CREATE TABLE sync_history (
    id INT PRIMARY KEY AUTO_INCREMENT,
    broker_connection_id INT NOT NULL,
    sync_type VARCHAR(50), -- 'executions', 'positions', 'balance'
    records_synced INT DEFAULT 0,
    status VARCHAR(20), -- 'success', 'failed', 'partial'
    error_message TEXT,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    FOREIGN KEY (broker_connection_id) REFERENCES broker_connections(id)
);
```

---

## 2️⃣ 交易执行记录

### 功能概述
完整记录交易的执行过程,包括多次部分成交、分批建仓/平仓等。

### 数据模型

```typescript
// zhixing_fronted/app/trades/execution-types.ts
export interface TradeExecution {
  id: number;
  tradeId: number; // 关联的交易计划ID
  executionTime: string;
  side: 'buy' | 'sell';
  quantity: number;
  price: number;
  amount: number; // quantity * price
  commission: number;
  slippage: number; // 与计划价格的偏差
  orderId?: string; // 券商订单ID
  executionId?: string; // 券商执行ID
  notes?: string;
  source: 'manual' | 'ibkr' | 'longbridge'; // 数据来源
}

export interface TradeExecutionSummary {
  tradeId: number;
  totalExecutions: number;
  totalQuantity: number;
  averagePrice: number;
  totalCommission: number;
  averageSlippage: number;
  firstExecutionTime: string;
  lastExecutionTime: string;
}
```

### UI组件

```tsx
// zhixing_fronted/components/trades/ExecutionHistory.tsx
'use client';

import { useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Clock, DollarSign, TrendingUp, Plus } from 'lucide-react';

interface ExecutionHistoryProps {
  tradeId: number;
  executions: TradeExecution[];
  onAddExecution: (execution: TradeExecution) => void;
}

export function ExecutionHistory({ tradeId, executions, onAddExecution }: ExecutionHistoryProps) {
  const [showAddDialog, setShowAddDialog] = useState(false);

  const summary = calculateSummary(executions);

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle>执行记录</CardTitle>
          <Button size="sm" onClick={() => setShowAddDialog(true)}>
            <Plus className="w-4 h-4 mr-2" /> 添加执行
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        {/* 汇总信息 */}
        <div className="grid grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
          <div>
            <p className="text-xs text-gray-500">总执行次数</p>
            <p className="text-lg font-semibold">{summary.totalExecutions}</p>
          </div>
          <div>
            <p className="text-xs text-gray-500">总成交量</p>
            <p className="text-lg font-semibold">{summary.totalQuantity}</p>
          </div>
          <div>
            <p className="text-xs text-gray-500">平均成交价</p>
            <p className="text-lg font-semibold">${summary.averagePrice.toFixed(2)}</p>
          </div>
          <div>
            <p className="text-xs text-gray-500">总佣金</p>
            <p className="text-lg font-semibold text-red-600">${summary.totalCommission.toFixed(2)}</p>
          </div>
        </div>

        {/* 执行列表 */}
        <div className="space-y-2">
          {executions.map((exec) => (
            <div
              key={exec.id}
              className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-900"
            >
              <div className="flex items-center gap-4">
                <div className={`px-2 py-1 rounded text-xs font-semibold ${
                  exec.side === 'buy' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                }`}>
                  {exec.side === 'buy' ? '买入' : '卖出'}
                </div>
                <div>
                  <p className="font-semibold">{exec.quantity} 股 @ ${exec.price}</p>
                  <p className="text-xs text-gray-500 flex items-center gap-1">
                    <Clock className="w-3 h-3" />
                    {new Date(exec.executionTime).toLocaleString()}
                  </p>
                </div>
              </div>
              <div className="text-right">
                <p className="font-semibold">${exec.amount.toFixed(2)}</p>
                <p className="text-xs text-gray-500">
                  佣金: ${exec.commission.toFixed(2)}
                  {exec.slippage !== 0 && (
                    <span className={exec.slippage > 0 ? 'text-red-500' : 'text-green-500'}>
                      {' '}| 滑点: {exec.slippage > 0 ? '+' : ''}{exec.slippage.toFixed(2)}%
                    </span>
                  )}
                </p>
              </div>
            </div>
          ))}
        </div>
      </CardContent>

      {/* 添加执行记录对话框 */}
      <Dialog open={showAddDialog} onOpenChange={setShowAddDialog}>
        <DialogContent>
          {/* 添加执行记录表单 */}
        </DialogContent>
      </Dialog>
    </Card>
  );
}
```

---

## 3️⃣ 复盘系统

### 功能概述
系统化的交易复盘工具,帮助交易者反思和改进。

### 核心功能

1. **日度复盘** - 每日交易总结
2. **周度复盘** - 每周总结与计划
3. **月度复盘** - 每月绩效回顾
4. **单笔复盘** - 深度分析单笔交易
5. **对比复盘** - 对比不同时期的表现

### 数据模型

```typescript
// zhixing_fronted/app/review/types.ts
export interface DailyReview {
  id: number;
  date: string;
  totalTrades: number;
  winningTrades: number;
  losingTrades: number;
  totalPnl: number;
  winRate: number;
  
  // 情绪与状态
  mentalState: 'excellent' | 'good' | 'normal' | 'tired' | 'stressed';
  marketCondition: 'bull' | 'bear' | 'sideways' | 'volatile';
  
  // 遵守纪律
  followedPlan: boolean;
  violations: string[];
  
  // 收获与反思
  learnings: string;
  mistakes: string;
  improvements: string;
  
  // 明日计划
  tomorrowPlan: string;
  
  createdAt: string;
  updatedAt: string;
}

export interface WeeklyReview {
  id: number;
  weekStart: string;
  weekEnd: string;
  
  // 数据统计
  totalTrades: number;
  totalPnl: number;
  winRate: number;
  bestDay: string;
  worstDay: string;
  
  // 本周总结
  achievements: string;
  challenges: string;
  patterns: string; // 发现的模式
  
  // 下周计划
  nextWeekGoals: string;
  focusAreas: string[];
  
  createdAt: string;
}

export interface TradeReview {
  tradeId: number;
  
  // 计划执行评估
  planExecutionScore: number; // 1-10分
  entryQuality: number; // 入场质量 1-10分
  exitQuality: number; // 出场质量 1-10分
  
  // 详细分析
  whatWentWell: string;
  whatWentWrong: string;
  lessonsLearned: string;
  wouldDoD ifferently: string;
  
  // 改进措施
  actionItems: string[];
  
  createdAt: string;
}
```

### UI组件

```tsx
// zhixing_fronted/app/review/page.tsx
'use client';

import { useState } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { DailyReviewPanel } from '@/components/review/DailyReviewPanel';
import { WeeklyReviewPanel } from '@/components/review/WeeklyReviewPanel';
import { MonthlyReviewPanel } from '@/components/review/MonthlyReviewPanel';
import { TradeReviewPanel } from '@/components/review/TradeReviewPanel';

export default function ReviewPage() {
  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">复盘系统</h1>

      <Tabs defaultValue="daily">
        <TabsList>
          <TabsTrigger value="daily">日度复盘</TabsTrigger>
          <TabsTrigger value="weekly">周度复盘</TabsTrigger>
          <TabsTrigger value="monthly">月度复盘</TabsTrigger>
          <TabsTrigger value="trade">交易复盘</TabsTrigger>
        </TabsList>

        <TabsContent value="daily">
          <DailyReviewPanel />
        </TabsContent>

        <TabsContent value="weekly">
          <WeeklyReviewPanel />
        </TabsContent>

        <TabsContent value="monthly">
          <MonthlyReviewPanel />
        </TabsContent>

        <TabsContent value="trade">
          <TradeReviewPanel />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```

---

## 4️⃣ 策略管理增强

### 功能概述
完善的策略标签系统、策略对比分析、策略效果追踪。

### 核心功能

1. **策略模板库** - 预定义常见策略
2. **策略效果追踪** - 实时统计各策略表现
3. **策略对比分析** - 多策略横向对比
4. **策略优化建议** - 基于数据的优化建议
5. **策略组合管理** - 管理策略组合

### UI组件

```tsx
// zhixing_fronted/app/strategies/page.tsx
'use client';

import { Card } from '@/components/ui/card';
import { StrategyPerformanceCard } from '@/components/strategies/StrategyPerformanceCard';
import { StrategyComparisonChart } from '@/components/strategies/StrategyComparisonChart';

export default function StrategiesPage() {
  const strategies = [
    {
      name: '动量突破',
      trades: 45,
      winRate: 0.62,
      totalPnl: 12450,
      avgWin: 520,
      avgLoss: -280,
      profitFactor: 2.1,
    },
    // ... more strategies
  ];

  return (
    <div className="container mx-auto p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">策略管理</h1>
        <Button>+ 新建策略</Button>
      </div>

      {/* 策略列表 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {strategies.map((strategy) => (
          <StrategyPerformanceCard key={strategy.name} strategy={strategy} />
        ))}
      </div>

      {/* 策略对比图表 */}
      <StrategyComparisonChart strategies={strategies} />
    </div>
  );
}
```

---

## 5️⃣ 检查清单系统

### 功能概述
交易前/后的检查清单,确保遵守交易纪律。

### 核心功能

1. **交易前检查清单** - 开仓前必须检查的项目
2. **交易后检查清单** - 平仓后的复盘项目
3. **每日检查清单** - 每日交易开始前的检查
4. **自定义检查清单** - 用户自定义检查项
5. **完成率统计** - 追踪检查清单完成情况

### 数据模型

```typescript
// zhixing_fronted/app/checklist/types.ts
export interface ChecklistItem {
  id: number;
  content: string;
  category: 'pre_trade' | 'post_trade' | 'daily';
  required: boolean;
  order: number;
}

export interface ChecklistCompletion {
  id: number;
  checklistItemId: number;
  tradeId?: number; // 如果是交易相关的检查清单
  date: string;
  completed: boolean;
  notes?: string;
  completedAt?: string;
}
```

### UI组件

```tsx
// zhixing_fronted/components/checklist/ChecklistDialog.tsx
'use client';

import { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';

interface ChecklistDialogProps {
  open: boolean;
  onClose: () => void;
  type: 'pre_trade' | 'post_trade' | 'daily';
  tradeId?: number;
}

export function ChecklistDialog({ open, onClose, type, tradeId }: ChecklistDialogProps) {
  const items = getChecklistItems(type);
  const [completedItems, setCompletedItems] = useState<Set<number>>(new Set());

  const allRequired Completed = items
    .filter(item => item.required)
    .every(item => completedItems.has(item.id));

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>
            {type === 'pre_trade' && '📋 交易前检查清单'}
            {type === 'post_trade' && '✅ 交易后检查清单'}
            {type === 'daily' && '🌅 每日检查清单'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-3">
          {items.map((item) => (
            <div key={item.id} className="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50">
              <Checkbox
                checked={completedItems.has(item.id)}
                onCheckedChange={(checked) => {
                  const newSet = new Set(completedItems);
                  if (checked) {
                    newSet.add(item.id);
                  } else {
                    newSet.delete(item.id);
                  }
                  setCompletedItems(newSet);
                }}
              />
              <div className="flex-1">
                <p className="text-sm">
                  {item.content}
                  {item.required && <span className="text-red-500 ml-1">*</span>}
                </p>
              </div>
            </div>
          ))}
        </div>

        <div className="flex justify-between items-center pt-4 border-t">
          <span className="text-sm text-gray-500">
            已完成 {completedItems.size}/{items.length}
          </span>
          <div className="flex gap-2">
            <Button variant="outline" onClick={onClose}>取消</Button>
            <Button
              disabled={!allRequiredCompleted}
              onClick={() => {
                saveChecklist(completedItems, tradeId);
                onClose();
              }}
            >
              确认完成
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

---

## 6️⃣ 心理分析

### 功能概述
记录和分析交易心理状态,识别情绪模式对交易的影响。

### 核心功能

1. **情绪记录** - 交易前/中/后的情绪状态
2. **情绪分析** - 情绪与交易表现的关联分析
3. **纪律性评分** - 评估交易纪律性
4. **心理模式识别** - 识别冲动交易、报复交易等
5. **心理报告** - 生成心理分析报告

### 数据模型

```typescript
// zhixing_fronted/app/psychology/types.ts
export interface EmotionRecord {
  id: number;
  tradeId?: number;
  date: string;
  
  // 情绪类型
  emotion: 'calm' | 'excited' | 'fearful' | 'greedy' | 'frustrated' | 'confident' | 'anxious';
  intensity: number; // 1-5
  
  // 时机
  timing: 'before' | 'during' | 'after';
  
  // 纪律性
  disciplineScore: number; // 1-10
  
  // 备注
  notes: string;
  
  createdAt: string;
}

export interface PsychologicalPattern {
  pattern: 'impulsive_trading' | 'revenge_trading' | 'over_trading' | 'analysis_paralysis';
  frequency: number;
  impact: 'high' | 'medium' | 'low';
  costEstimate: number;
  examples: number[]; // trade IDs
}
```

### UI组件

```tsx
// zhixing_fronted/app/psychology/page.tsx
'use client';

import { Card } from '@/components/ui/card';
import { EmotionChart } from '@/components/psychology/EmotionChart';
import { DisciplineChart } from '@/components/psychology/DisciplineChart';
import { PatternCard } from '@/components/psychology/PatternCard';

export default function PsychologyPage() {
  return (
    <div className="container mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold">心理分析</h1>

      {/* 情绪分布 */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">情绪状态分析</h2>
        <EmotionChart />
      </Card>

      {/* 纪律性趋势 */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">纪律性追踪</h2>
        <DisciplineChart />
      </Card>

      {/* 心理模式 */}
      <div>
        <h2 className="text-xl font-semibold mb-4">识别的心理模式</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <PatternCard
            pattern="impulsive_trading"
            title="冲动交易"
            frequency={5}
            impact="high"
            cost={1250}
          />
          <PatternCard
            pattern="revenge_trading"
            title="报复性交易"
            frequency={3}
            impact="medium"
            cost={780}
          />
        </div>
      </div>
    </div>
  );
}
```

---

## 7️⃣ 错误分析

### 功能概述
系统化地记录、分类和分析交易错误,持续改进。

### 核心功能

1. **错误分类** - 入场错误、出场错误、仓位错误、心理错误
2. **错误标记** - 为交易标记具体错误
3. **错误成本计算** - 计算每类错误的损失
4. **错误趋势** - 追踪错误是否在减少
5. **改进计划** - 针对错误制定改进措施

### UI组件

```tsx
// zhixing_fronted/app/errors/page.tsx
'use client';

import { Card } from '@/components/ui/card';
import { ErrorCategoryCard } from '@/components/errors/ErrorCategoryCard';
import { ErrorTrendChart } from '@/components/errors/ErrorTrendChart';
import { ImprovementPlan } from '@/components/errors/ImprovementPlan';

export default function ErrorsPage() {
  const errorCategories = [
    {
      category: 'entry_error',
      name: '入场错误',
      count: 8,
      cost: 1450,
      examples: ['入场过早', '未等待确认信号', '逆势入场'],
    },
    {
      category: 'exit_error',
      name: '出场错误',
      count: 12,
      cost: 2340,
      examples: ['过早止盈', '未执行止损', '情绪化平仓'],
    },
    // ... more categories
  ];

  return (
    <div className="container mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold">错误分析</h1>

      {/* 错误分类统计 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {errorCategories.map((cat) => (
          <ErrorCategoryCard key={cat.category} category={cat} />
        ))}
      </div>

      {/* 错误趋势 */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">错误趋势</h2>
        <ErrorTrendChart />
      </Card>

      {/* 改进计划 */}
      <Card className="p-6">
        <h2 className="text-xl font-semibold mb-4">改进计划</h2>
        <ImprovementPlan />
      </Card>
    </div>
  );
}
```

---

## 8️⃣ 数据透视表

### 功能概述
强大的多维数据分析工具,类似Excel透视表。

### 核心功能

1. **拖拽式界面** - 拖拽字段到行/列/值区域
2. **多维度分析** - 按策略、时间、资产类型等多维度交叉分析
3. **自定义聚合** - 求和、平均、计数、最大、最小
4. **动态筛选** - 实时筛选数据
5. **导出功能** - 导出为CSV/Excel

### 技术选型

使用 `react-pivottable` 库或 `ag-grid` 实现。

### UI组件

```tsx
// zhixing_fronted/app/pivot/page.tsx
'use client';

import dynamic from 'next/dynamic';
import 'react-pivottable/pivottable.css';

const PivotTableUI = dynamic(
  () => import('react-pivottable').then((mod) => mod.PivotTableUI),
  { ssr: false }
);

export default function PivotTablePage() {
  const [pivotState, setPivotState] = useState({});

  // 准备数据
  const data = trades.map((trade) => ({
    '交易品种': trade.symbol,
    '策略': trade.strategy,
    '方向': trade.side === 'buy' ? '做多' : '做空',
    '盈亏': trade.pnl,
    '胜负': trade.pnl > 0 ? '盈利' : '亏损',
    '日期': new Date(trade.createdAt).toLocaleDateString(),
    '月份': new Date(trade.createdAt).getMonth() + 1,
    '星期': ['日', '一', '二', '三', '四', '五', '六'][new Date(trade.createdAt).getDay()],
    '数量': trade.quantity,
    '成交额': trade.amount,
  }));

  return (
    <div className="container mx-auto p-6">
      <h1 className="text-3xl font-bold mb-6">数据透视表</h1>

      <Card className="p-6">
        <PivotTableUI
          data={data}
          onChange={(s) => setPivotState(s)}
          {...pivotState}
        />
      </Card>
    </div>
  );
}
```

---

## 📅 开发计划

### 第一阶段 (第1-3周)
- **Week 1**: 券商API集成 - IBKR
- **Week 2**: 券商API集成 - Longbridge + 交易执行记录
- **Week 3**: 复盘系统

### 第二阶段 (第4-6周)
- **Week 4**: 策略管理增强
- **Week 5**: 检查清单系统
- **Week 6**: 心理分析

### 第三阶段 (第7-8周)
- **Week 7**: 错误分析
- **Week 8**: 数据透视表

### 第四阶段 (第9-10周)
- **Week 9**: 集成测试与优化
- **Week 10**: 文档编写与交付

---

## 📦 依赖安装清单

### Backend
```bash
pip install ib_insync>=0.9.86
pip install longbridge>=1.0.0
pip install asyncio
pip install cryptography  # 用于加密存储券商凭证
```

### Frontend
```bash
npm install react-pivottable
npm install plotly.js  # 用于数据透视表的图表展示
npm install recharts  # 用于各种图表
npm install date-fns  # 日期处理
npm install lucide-react  # 图标
```

---

## 🎯 成功指标

1. **券商API**: 成功同步至少90%的交易记录
2. **执行记录**: 支持多次部分成交的完整记录
3. **复盘系统**: 日度复盘完成率>80%
4. **策略管理**: 至少5个预定义策略模板
5. **检查清单**: 用户自定义检查清单数量>10
6. **心理分析**: 识别至少4种心理模式
7. **错误分析**: 至少6个错误分类
8. **数据透视**: 支持至少5个维度的交叉分析

---

## 📝 备注

- 所有功能均需后端数据持久化支持
- UI需保持一致的设计语言
- 移动端响应式设计
- 暗色模式支持
- 完善的错误处理和用户提示
- 详细的用户文档和视频教程

---

**文档版本**: v1.0  
**最后更新**: 2025年10月18日  
**负责人**: AI开发团队

